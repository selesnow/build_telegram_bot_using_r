<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Глава 8 Упаковываем бота в Docker контейнер | Разработка telegram ботов на языке R</title>
<meta name="author" content="Алексей Селезнёв">
<meta name="description" content="8.1 Что такое докер Docker — программное обеспечение для автоматизации развёртывания и управления приложениями в средах с поддержкой контейнеризации, контейнеризатор приложений. Позволяет...">
<meta name="generator" content="bookdown 0.27 with bs4_book()">
<meta property="og:title" content="Глава 8 Упаковываем бота в Docker контейнер | Разработка telegram ботов на языке R">
<meta property="og:type" content="book">
<meta property="og:image" content="/cover.png">
<meta property="og:description" content="8.1 Что такое докер Docker — программное обеспечение для автоматизации развёртывания и управления приложениями в средах с поддержкой контейнеризации, контейнеризатор приложений. Позволяет...">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Глава 8 Упаковываем бота в Docker контейнер | Разработка telegram ботов на языке R">
<meta name="twitter:description" content="8.1 Что такое докер Docker — программное обеспечение для автоматизации развёртывания и управления приложениями в средах с поддержкой контейнеризации, контейнеризатор приложений. Позволяет...">
<meta name="twitter:image" content="/cover.png">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.4.0/transition.js"></script><script src="libs/bs3compat-0.4.0/tabs.js"></script><script src="libs/bs3compat-0.4.0/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114798296-1"></script><script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-114798296-1');
    </script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS --><style type="text/css">
    
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  </style>
<link rel="stylesheet" href="bs4_style.css">
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">Разработка telegram ботов на языке R</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html">Введение</a></li>
<li><a class="" href="%D1%81%D0%BE%D0%B7%D0%B4%D0%B0%D1%91%D0%BC-%D0%B1%D0%BE%D1%82%D0%B0-%D0%B8-%D0%BE%D1%82%D0%BF%D1%80%D0%B0%D0%B2%D0%BB%D1%8F%D0%B5%D0%BC-%D1%81-%D0%B5%D0%B3%D0%BE-%D0%BF%D0%BE%D0%BC%D0%BE%D1%89%D1%8C%D1%8E-%D1%81%D0%BE%D0%BE%D0%B1%D1%89%D0%B5%D0%BD%D0%B8%D1%8F-%D0%B2-telegram.html"><span class="header-section-number">1</span> Создаём бота, и отправляем с его помощью сообщения в telegram</a></li>
<li><a class="" href="%D0%B4%D0%BE%D0%B1%D0%B0%D0%B2%D0%BB%D1%8F%D0%B5%D0%BC-%D0%B1%D0%BE%D1%82%D1%83-%D0%BF%D0%BE%D0%B4%D0%B4%D0%B5%D1%80%D0%B6%D0%BA%D1%83-%D0%BA%D0%BE%D0%BC%D0%B0%D0%BD%D0%B4-%D0%B8-%D1%84%D0%B8%D0%BB%D1%8C%D1%82%D1%80%D1%8B-%D1%81%D0%BE%D0%BE%D0%B1%D1%89%D0%B5%D0%BD%D0%B8%D0%B9-%D0%BA%D0%BB%D0%B0%D1%81%D1%81-updater.html"><span class="header-section-number">2</span> Добавляем боту поддержку команд и фильтры сообщений, класс Updater</a></li>
<li><a class="" href="%D0%BA%D0%B0%D0%BA-%D0%B4%D0%BE%D0%B1%D0%B0%D0%B2%D0%B8%D1%82%D1%8C-%D0%B1%D0%BE%D1%82%D1%83-%D0%BF%D0%BE%D0%B4%D0%B4%D0%B5%D1%80%D0%B6%D0%BA%D1%83-%D0%BA%D0%BB%D0%B0%D0%B2%D0%B8%D0%B0%D1%82%D1%83%D1%80%D1%8B.html"><span class="header-section-number">3</span> Как добавить боту поддержку клавиатуры</a></li>
<li><a class="" href="%D0%BF%D0%BE%D1%81%D1%82%D1%80%D0%BE%D0%B5%D0%BD%D0%B8%D0%B5-%D0%BF%D0%BE%D1%81%D0%BB%D0%B5%D0%B4%D0%BE%D0%B2%D0%B0%D1%82%D0%B5%D0%BB%D1%8C%D0%BD%D0%BE%D0%B3%D0%BE-%D0%BB%D0%BE%D0%B3%D0%B8%D1%87%D0%B5%D1%81%D0%BA%D0%BE%D0%B3%D0%BE-%D0%B4%D0%B8%D0%B0%D0%BB%D0%BE%D0%B3%D0%B0-%D1%81-%D0%B1%D0%BE%D1%82%D0%BE%D0%BC.html"><span class="header-section-number">4</span> Построение последовательного, логического диалога с ботом</a></li>
<li><a class="" href="%D1%83%D0%BF%D1%80%D0%B0%D0%B2%D0%BB%D0%B5%D0%BD%D0%B8%D0%B5-%D0%BF%D1%80%D0%B0%D0%B2%D0%B0%D0%BC%D0%B8-%D0%BF%D0%BE%D0%BB%D1%8C%D0%B7%D0%BE%D0%B2%D0%B0%D1%82%D0%B5%D0%BB%D0%B5%D0%B9-%D0%B1%D0%BE%D1%82%D0%B0.html"><span class="header-section-number">5</span> Управление правами пользователей бота</a></li>
<li><a class="" href="%D0%BF%D0%BE%D0%B2%D1%8B%D1%88%D0%B0%D0%B5%D0%BC-%D1%81%D1%82%D0%B0%D0%B1%D0%B8%D0%BB%D1%8C%D0%BD%D0%BE%D1%81%D1%82%D1%8C-%D1%80%D0%B0%D0%B1%D0%BE%D1%82%D1%8B-%D0%B1%D0%BE%D1%82%D0%B0.html"><span class="header-section-number">6</span> Повышаем стабильность работы бота</a></li>
<li><a class="" href="%D0%B4%D0%BE%D0%B1%D0%B0%D0%B2%D0%BB%D1%8F%D0%B5%D0%BC-%D0%B1%D0%BE%D1%82%D1%83-%D0%B0%D1%81%D0%B8%D0%BD%D1%85%D1%80%D0%BE%D0%BD%D0%BD%D0%BE%D1%81%D1%82%D1%8C.html"><span class="header-section-number">7</span> Добавляем боту асинхронность</a></li>
<li><a class="active" href="%D1%83%D0%BF%D0%B0%D0%BA%D0%BE%D0%B2%D1%8B%D0%B2%D0%B0%D0%B5%D0%BC-%D0%B1%D0%BE%D1%82%D0%B0-%D0%B2-docker-%D0%BA%D0%BE%D0%BD%D1%82%D0%B5%D0%B9%D0%BD%D0%B5%D1%80.html"><span class="header-section-number">8</span> Упаковываем бота в Docker контейнер</a></li>
<li><a class="" href="%D0%BE%D0%B1%D0%BD%D0%BE%D0%B2%D0%BB%D0%B5%D0%BD%D0%B8%D1%8F.html">Обновления</a></li>
<li><a class="" href="%D1%80%D0%B5%D1%88%D0%B5%D0%BD%D0%B8%D0%B5-%D0%B7%D0%B0%D0%B4%D0%B0%D1%87.html">Решение задач</a></li>
</ul>

        <div class="book-extra">
          
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="упаковываем-бота-в-docker-контейнер" class="section level1" number="8">
<h1>
<span class="header-section-number">Глава 8</span> Упаковываем бота в Docker контейнер<a class="anchor" aria-label="anchor" href="#%D1%83%D0%BF%D0%B0%D0%BA%D0%BE%D0%B2%D1%8B%D0%B2%D0%B0%D0%B5%D0%BC-%D0%B1%D0%BE%D1%82%D0%B0-%D0%B2-docker-%D0%BA%D0%BE%D0%BD%D1%82%D0%B5%D0%B9%D0%BD%D0%B5%D1%80"><i class="fas fa-link"></i></a>
</h1>
<div id="что-такое-докер" class="section level2" number="8.1">
<h2>
<span class="header-section-number">8.1</span> Что такое докер<a class="anchor" aria-label="anchor" href="#%D1%87%D1%82%D0%BE-%D1%82%D0%B0%D0%BA%D0%BE%D0%B5-%D0%B4%D0%BE%D0%BA%D0%B5%D1%80"><i class="fas fa-link"></i></a>
</h2>
<p>Docker — программное обеспечение для автоматизации развёртывания и управления приложениями в средах с поддержкой контейнеризации, контейнеризатор приложений. Позволяет «упаковать» приложение со всем его окружением и зависимостями в контейнер.</p>
<p>Docker предназначен для заключения сред внутри образа/контейнера. Это позволяет, например, иметь компьютер с Linux на Windows или компьютер с R 3.3, когда на вашем основном компьютере установлен R 3.5. Кроме того, это означает, что вы можете использовать более старые версии пакета для конкретной задачи, сохраняя при этом пакет на вашем компьютере в актуальном состоянии.</p>
<p>Т.е. вы можете запустить бота в абсолютно изолированной среде, на которой будет предустановлены всё необходимое ПО, настроены переменные окружения, и она никак не будет зависеть от внешних настроек вашей операционной системы. Соответственно, при запуске контейнера по созданному образу на любой другой машине, вам не придётся её каким либо образом предварительно настраивать, прописывать переменные среды, устанавливать нужные пакеты, устанавливать сам язык R и т.д.</p>
<p>В этом учебнике мы не будем подробно изучать сам Docker, т.к. это отдельная большая тема, а учебник у нас по разработке telegram ботов, а не работе с Docker. Но в интернете вы без проблем найдёте огромное количество статей и видео уроков, которые помогут вам глубже погрузиться в изучение возможностей Docker, несколько полезных ссылок я приведу в завершении данной главы. Здесь же мы лишь рассмотрим рабочий процесс упаковки и запуска бота написанного на языке R. В нашем случае мы рассмотрим рабочий процесс упаковки на примере ОС Windows 10 Home, но на других ОС процесс будет отличаться не значительно.</p>
<blockquote>
<p>Описанные в этой главе приёмы универсальны, по такому же принципу можно упаковать в Docker и запустить любой R скрипт.</p>
</blockquote>
</div>
<div id="установка-docker" class="section level2" number="8.2">
<h2>
<span class="header-section-number">8.2</span> Установка Docker<a class="anchor" aria-label="anchor" href="#%D1%83%D1%81%D1%82%D0%B0%D0%BD%D0%BE%D0%B2%D0%BA%D0%B0-docker"><i class="fas fa-link"></i></a>
</h2>
<p>Для начала вам необходимо скачать и установить Docker на свой ПК. Тут есть некоторый нюанс, дело в том, что для Windows есть два варианта Docker:</p>
<ol style="list-style-type: decimal">
<li>Docker for Windows</li>
<li>Docker Toolbox on Windows</li>
</ol>
<p>Какую версию выбрать вам:</p>
<ul>
<li>Если у вас Windows 10 x64 Pro, Enterprise или Education то включаем службу Hyper-V и ставим Docker for Windows.</li>
<li>Если же у вас другая версия Windows(7 Pro, 8, 8.1, 10 Home) то ставим Virtual Box и Docker Toolbox on Windows.</li>
</ul>
<p>У меня Windows 10 Home, если у вас тоже то перейдите по <a href="https://github.com/docker-archive/toolbox/releases">ссылке</a>, скачайте инсталлятор для своей операционной системы и запустите процесс установки.</p>
<p>У меня никаких дополнительных манипуляций процесс установки не потребовал, но в случае возникновения каких либо сложностей, я рекомендую найти на YouTube урок по установке Docker на вашу операционную систему. Например, в <a href="https://www.youtube.com/watch?v=a5mxBTGfC5k">этом видео</a> рассматривается процесс установки как Docker for Windows, так и Docker Toolbox on Windows.</p>
<p>Все приведённые ниже примеры использовались с Docker Toolbox on Windows.</p>
<p>По завершению установки запустите <code>Docker Quickstart Terminal</code>, ярлык вы найдёте на рабочем столе.</p>
<div class="inline-figure"><img src="img/8-1.png" border="0" width="280" style="border: none;"></div>
</div>
<div id="создаём-проект-в-rstudio" class="section level2" number="8.3">
<h2>
<span class="header-section-number">8.3</span> Создаём проект в RStudio<a class="anchor" aria-label="anchor" href="#%D1%81%D0%BE%D0%B7%D0%B4%D0%B0%D1%91%D0%BC-%D0%BF%D1%80%D0%BE%D0%B5%D0%BA%D1%82-%D0%B2-rstudio"><i class="fas fa-link"></i></a>
</h2>
<p>Для удобства работы я рекомендую создать проект.</p>
<p>Открываем RStudio и создаём новый проект. Перейдите в меню <code>file -&gt; New Project...</code>.</p>
<div class="inline-figure"><img src="img/8-2.png" border="0" width="450" style="border: none;"></div>
<p>Далее выбираем “New project” и указываем имя проекта.</p>
<div class="inline-figure"><img src="img/8-3.png" border="0" width="450" style="border: none;"></div>
</div>
<div id="код-бота" class="section level2" number="8.4">
<h2>
<span class="header-section-number">8.4</span> Код бота<a class="anchor" aria-label="anchor" href="#%D0%BA%D0%BE%D0%B4-%D0%B1%D0%BE%D1%82%D0%B0"><i class="fas fa-link"></i></a>
</h2>
<p>В данном случае нам не особо важен функционал нашего бота, поэтому мы просто возьмём код асинхронного бота из 7ой главы этого учебника, но предварительно немного его доработали:</p>
<ol style="list-style-type: decimal">
<li>Мы добавили команду очистки очереди бота от старых сообщений, сразу после его инициализации.</li>
<li>Добавили боту две новые команды:
<ol style="list-style-type: decimal">
<li>
<code>/stop</code> - Команда остановки бота.</li>
<li>
<code>/crush</code> - Команда с ошибкой, имитирующая падение бота.</li>
</ol>
</li>
<li>Добавили боту процесс логирования его работы в обычный текстовый файл <code>bot.log</code>.</li>
</ol>
<p>Все эти доработки нам потребовались для демонстрации некоторых дополнительных возможностей, которые даёт Docker.</p>
<p>Меню file -&gt; New file -&gt; R script (или сочетание клавиш Ctrl+Shift+N). Далее скопируйте приведённый ниже код бота, и сохраните его с именем <code>bot.R</code>.</p>
<div class="sourceCode" id="cb75"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/ebeneditos/telegram.bot">telegram.bot</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://stringr.tidyverse.org">stringr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://s-fleck.github.io/lgr/">lgr</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Включаем логгер</span></span>
<span><span class="va">lg</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://s-fleck.github.io/lgr/reference/get_logger.html">get_logger</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">lg</span><span class="op">$</span><span class="fu">set_appenders</span><span class="op">(</span><span class="va"><a href="https://s-fleck.github.io/lgr/reference/AppenderFile.html">AppenderFile</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>file <span class="op">=</span> <span class="st">'log/bot.log'</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">lg</span><span class="op">$</span><span class="fu">info</span><span class="op">(</span><span class="st">'Bot start'</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Включаем параллельный план вычислений</span></span>
<span><span class="va">lg</span><span class="op">$</span><span class="fu">info</span><span class="op">(</span><span class="st">'Run multisession mode'</span><span class="op">)</span></span>
<span><span class="fu">future</span><span class="fu">::</span><span class="fu"><a href="https://future.futureverse.org/reference/plan.html">plan</a></span><span class="op">(</span><span class="st">'multisession'</span>, workers <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Инициализируем бота</span></span>
<span><span class="va">lg</span><span class="op">$</span><span class="fu">info</span><span class="op">(</span><span class="st">'Make updater'</span><span class="op">)</span></span>
<span><span class="va">updater</span> <span class="op">&lt;-</span>  <span class="fu"><a href="https://rdrr.io/pkg/telegram.bot/man/Updater.html">Updater</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/telegram.bot/man/bot_token.html">bot_token</a></span><span class="op">(</span><span class="st">'botname'</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># Очищаем очередь бота от старых сообщений</span></span>
<span><span class="va">lg</span><span class="op">$</span><span class="fu">info</span><span class="op">(</span><span class="st">'Clean update queue'</span><span class="op">)</span></span>
<span><span class="va">updater</span><span class="op">$</span><span class="va">bot</span><span class="op">$</span><span class="fu">clean_updates</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Функция с длительным временем вычислений</span></span>
<span><span class="va">slow_fun</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">bot</span>, <span class="va">update</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="va">lg</span><span class="op">$</span><span class="fu">info</span><span class="op">(</span><span class="st">'Run slow command'</span><span class="op">)</span></span>
<span>  <span class="co"># Запускаем выполнение кода в параллельной сессии</span></span>
<span>  <span class="fu">promises</span><span class="fu">::</span><span class="fu"><a href="https://rstudio.github.io/promises//reference/future_promise.html">future_promise</a></span><span class="op">(</span></span>
<span>    <span class="op">{</span></span>
<span>      <span class="co"># Сообщение о том, что начата работа длительного вычисления</span></span>
<span>      <span class="va">bot</span><span class="op">$</span><span class="fu">sendMessage</span><span class="op">(</span><span class="va">update</span><span class="op">$</span><span class="va">message</span><span class="op">$</span><span class="va">chat_id</span>,</span>
<span>        text <span class="op">=</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_glue.html">str_glue</a></span><span class="op">(</span><span class="st">"Медленная функция, начало работы!\nID процесса: {Sys.getpid()}"</span><span class="op">)</span>,</span>
<span>        parse_mode <span class="op">=</span> <span class="st">"Markdown"</span><span class="op">)</span></span>
<span>      </span>
<span>      <span class="co"># Добавляем паузу, для того, что бы искусственно сделать функцию длительной</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/Sys.sleep.html">Sys.sleep</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span></span>
<span>      </span>
<span>      <span class="co"># Сообщаем о том, что все вычисления выполнены</span></span>
<span>      <span class="va">bot</span><span class="op">$</span><span class="fu">sendMessage</span><span class="op">(</span><span class="va">update</span><span class="op">$</span><span class="va">message</span><span class="op">$</span><span class="va">chat_id</span>,</span>
<span>        text <span class="op">=</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_glue.html">str_glue</a></span><span class="op">(</span><span class="st">"Медленная функция выполнена!\nID процесса: {Sys.getpid()}"</span><span class="op">)</span>,</span>
<span>        parse_mode <span class="op">=</span> <span class="st">"Markdown"</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">)</span></span>
<span>  </span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Функция с коротким временем вычислений</span></span>
<span><span class="va">fast_fun</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">bot</span>, <span class="va">update</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="va">lg</span><span class="op">$</span><span class="fu">info</span><span class="op">(</span><span class="st">'Run fast command'</span><span class="op">)</span></span>
<span>  <span class="co"># Просто отправляем сообщение</span></span>
<span>  <span class="va">bot</span><span class="op">$</span><span class="fu">sendMessage</span><span class="op">(</span><span class="va">update</span><span class="op">$</span><span class="va">message</span><span class="op">$</span><span class="va">chat_id</span>,</span>
<span>    text <span class="op">=</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_glue.html">str_glue</a></span><span class="op">(</span><span class="st">"Быстрая функция, выполняется последовательный режим!\nID процесса: {Sys.getpid()}"</span><span class="op">)</span>,</span>
<span>    parse_mode <span class="op">=</span> <span class="st">"Markdown"</span><span class="op">)</span></span>
<span>  </span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Остановка пуллинга</span></span>
<span><span class="va">stop</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">bot</span>, <span class="va">update</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="va">lg</span><span class="op">$</span><span class="fu">info</span><span class="op">(</span><span class="st">'Bot stop'</span><span class="op">)</span></span>
<span>  <span class="va">bot</span><span class="op">$</span><span class="fu">sendMessage</span><span class="op">(</span><span class="va">update</span><span class="op">$</span><span class="va">message</span><span class="op">$</span><span class="va">chat_id</span>,</span>
<span>    text <span class="op">=</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_glue.html">str_glue</a></span><span class="op">(</span><span class="st">"Останавливаю работу бота!\nID процесса: {Sys.getpid()}"</span><span class="op">)</span>,</span>
<span>    parse_mode <span class="op">=</span> <span class="st">"Markdown"</span><span class="op">)</span></span>
<span>  <span class="co"># Просто отправляем сообщение</span></span>
<span>  <span class="va">updater</span><span class="op">$</span><span class="fu">stop_polling</span><span class="op">(</span><span class="op">)</span></span>
<span>  </span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Функция с ошибкой, имитирующая падение бота</span></span>
<span><span class="va">crush</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">bot</span>, <span class="va">update</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="va">lg</span><span class="op">$</span><span class="fu">info</span><span class="op">(</span><span class="st">'Crush command'</span><span class="op">)</span></span>
<span>  <span class="va">bot</span><span class="op">$</span><span class="fu">sendMessage</span><span class="op">(</span><span class="va">update</span><span class="op">$</span><span class="va">message</span><span class="op">$</span><span class="va">chat_id</span>,</span>
<span>    text <span class="op">=</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_glue.html">str_glue</a></span><span class="op">(</span><span class="st">"Функция с ошибкой, сбой в работе бота!\nID процесса: {Sys.getpid()}"</span><span class="op">)</span>,</span>
<span>    parse_mode <span class="op">=</span> <span class="st">"Markdown"</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/stop.html">stop</a></span><span class="op">(</span><span class="st">"Ошибка, сбой бота!"</span><span class="op">)</span></span>
<span>  </span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># создаём обработчик</span></span>
<span><span class="va">lg</span><span class="op">$</span><span class="fu">info</span><span class="op">(</span><span class="st">'Make handlers'</span><span class="op">)</span></span>
<span><span class="va">slow_hendler</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/telegram.bot/man/CommandHandler.html">CommandHandler</a></span><span class="op">(</span><span class="st">'slow'</span>, <span class="va">slow_fun</span><span class="op">)</span></span>
<span><span class="va">fast_hendler</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/telegram.bot/man/CommandHandler.html">CommandHandler</a></span><span class="op">(</span><span class="st">'fast'</span>, <span class="va">fast_fun</span><span class="op">)</span></span>
<span><span class="va">stop_hendler</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/telegram.bot/man/CommandHandler.html">CommandHandler</a></span><span class="op">(</span><span class="st">'stop'</span>, <span class="va">stop</span><span class="op">)</span></span>
<span><span class="va">crush_hendler</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/telegram.bot/man/CommandHandler.html">CommandHandler</a></span><span class="op">(</span><span class="st">'crush'</span>, <span class="va">crush</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># добавляем в диспетчер</span></span>
<span><span class="va">lg</span><span class="op">$</span><span class="fu">info</span><span class="op">(</span><span class="st">'Add handlers to dispatcher'</span><span class="op">)</span></span>
<span><span class="va">updater</span> <span class="op">&lt;-</span> <span class="va">updater</span> <span class="op">+</span> <span class="va">slow_hendler</span> <span class="op">+</span> <span class="va">fast_hendler</span> <span class="op">+</span> <span class="va">stop_hendler</span> <span class="op">+</span> <span class="va">crush_hendler</span></span>
<span></span>
<span><span class="co"># запускаем бота</span></span>
<span><span class="va">lg</span><span class="op">$</span><span class="fu">info</span><span class="op">(</span><span class="st">'Run polling'</span><span class="op">)</span></span>
<span><span class="va">updater</span><span class="op">$</span><span class="fu">start_polling</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<blockquote>
<p>Обратите внимание, я явно указал количество потоков <code>future::plan('multisession', workers = 4)</code>, т.к. в контейнере по умолчанию функция <code>plan()</code> определит всего 1 ядро, и соответственно бот будет запущен в последовательном режиме работы.</p>
</blockquote>
</div>
<div id="образы-и-контейнеры" class="section level2" number="8.5">
<h2>
<span class="header-section-number">8.5</span> Образы и контейнеры<a class="anchor" aria-label="anchor" href="#%D0%BE%D0%B1%D1%80%D0%B0%D0%B7%D1%8B-%D0%B8-%D0%BA%D0%BE%D0%BD%D1%82%D0%B5%D0%B9%D0%BD%D0%B5%D1%80%D1%8B"><i class="fas fa-link"></i></a>
</h2>
<p>В основе работы Docker лежат образы и созданные из них контейнеры. Образы — это описание среды и её настроек, необходимых для работы вашего бота (R, пакеты, переменные среды), а контейнеры — это фактически запущенные экземпляры образов. Образ создаётся один раз, а контейнеры будут запускаться всякий раз, когда вам необходимо запустить бота. И, конечно же, одновременно можно запускать несколько контейнеров с одними и теми же образами.</p>
<p>Применительно к R, это тот же принцип, что установка и загрузка пакета. Для начала вам необходимо один раз установить пакет командой <code><a href="https://rdrr.io/r/utils/install.packages.html">install.packages()</a></code>, а потом подключать его командой <code><a href="https://rdrr.io/r/base/library.html">library()</a></code> каждый раз, когда вам требуется его функционал. И пакет можно легко запустить в нескольких сеансах R одновременно.</p>
<p>Продолжая аналогию с пакетами, создание образа по смыслу схоже на команду <code><a href="https://rdrr.io/r/utils/install.packages.html">install.packages()</a></code>, а запуск контейнера на основе образа по смыслу близко к команде <code><a href="https://rdrr.io/r/base/library.html">library()</a></code>.</p>
</div>
<div id="создание-dockerfile" class="section level2" number="8.6">
<h2>
<span class="header-section-number">8.6</span> Создание Dockerfile<a class="anchor" aria-label="anchor" href="#%D1%81%D0%BE%D0%B7%D0%B4%D0%B0%D0%BD%D0%B8%D0%B5-dockerfile"><i class="fas fa-link"></i></a>
</h2>
<p>Docker образ создаётся из <code>Dockerfile</code>. По сути это обычный текстовый файл, без расширения, в котором вы прописываете команды для развёртывания нужной для запуска вашего бота среды.</p>
<p>Теперь необходимо создать в рабочей директории проекта обычный текстовый файл, и дать ему имя <code>Dockerfile</code>.</p>
<div class="inline-figure"><img src="img/8-4.png"></div>
<p>Докер файл будет содержать следующие команды:</p>
<pre><code>FROM rocker/r-ver:4.2.1

RUN mkdir /home/bot
RUN mkdir /home/bot/log

ENV R_TELEGRAM_BOT_botname ТОКЕН_ВАШЕГО_БОТА

COPY bot.R /home/bot/bot.R

RUN R -e "install.packages(c('telegram.bot', 'stringr', 'future', 'promises','fastmap', 'lgr'))"

CMD cd /home/bot \
  &amp;&amp;  R -e "source('/home/bot/bot.R')"</code></pre>
<p>Тут давайте остановимся и разберём отдельно каждую команду:</p>
<ol style="list-style-type: decimal">
<li>
<code>FROM rocker/r-ver:4.2.1</code>, создаёт среду с установленным R 4.2.1, вы можете указать любую, нужную вам версию R.</li>
<li>
<code>RUN mkdir /home/bot</code> и <code>RUN mkdir /home/bot/log</code> создаёт в контейнере папку <code>bot</code>, и папку <code>log</code> внутри неё.</li>
<li>
<code>ENV R_TELEGRAM_BOT_botname ТОКЕН_ВАШЕГО_БОТА</code> эта команда создаёт переменную среды <code>R_TELEGRAM_BOT_botname</code> внутри контейнера. В данную переменную передайте токен вашего бота.</li>
<li>
<code>COPY bot.R /home/bot/bot.R</code> копирует скрипт с кодом нашего бота в контейнер.</li>
<li>
<code>RUN R -e "install.packages(c('telegram.bot', 'stringr', 'future', 'promises','fastmap', 'lgr'))"</code>, конструкция <code>RUN R -e "код на R"</code> позволяет запускать внутри контейнера R команды. В данном случае мы устанавливаем все, нужные нам пакеты.</li>
<li>
<code>CMD cd /home/bot</code>, команда, которая переключает рабочую директорию на /home/bot. Команда <code>CMD</code> запускается каждый раз, при запуске контейнера.</li>
<li>
<code>&amp;&amp; R -e "source('/home/analysis/bot.R')"</code>, объединяется с предыдущей командой, и запускает скрипт бота.</li>
</ol>
<p>Если вам необходимы определённые версии используемых пакетов то вы можете заменить команду из 5 пункта на:</p>
<pre><code>RUN R -e "install.packages('remotes'); \
  remotes::install_version('package_name', '0.1.2')"</code></pre>
<p>Или установить пакет из снимка MRAN на определённую дату:</p>
<pre><code>RUN R -e "options(repos = \
  list(CRAN = 'http://mran.revolutionanalytics.com/snapshot/2022-08-01/')); \
  install.packages('package_name')"</code></pre>
</div>
<div id="создание-образа" class="section level2" number="8.7">
<h2>
<span class="header-section-number">8.7</span> Создание образа<a class="anchor" aria-label="anchor" href="#%D1%81%D0%BE%D0%B7%D0%B4%D0%B0%D0%BD%D0%B8%D0%B5-%D0%BE%D0%B1%D1%80%D0%B0%D0%B7%D0%B0"><i class="fas fa-link"></i></a>
</h2>
<p>Теперь нам необходимо перейти в терминал, и запустить команду создания образа <code>docker build</code>. Данная команда требует от вас передачи нескольких параметров:</p>
<ol style="list-style-type: decimal">
<li>
<code>-t</code> - позволяет задать тег вашего образа;</li>
<li>вторым параметром является путь к папке с <code>Dockerfile</code>, если вы создали <code>Dockerfile</code> в текущем рабочем каталоге проекта, то просто в качестве этого параметра передайте точку.</li>
</ol>
<p>Т.е. для создания образа перейдите в терминал (найти терминал можно на соседней вкладке с консолью в RStudio) и запустите в терминале (не в консоли RStudio, а именно в терминале!) следующую команду:</p>
<pre><code>docker build -t rbot .</code></pre>
<div class="inline-figure"><img src="img/8-5.png" border="0" width="630" style="border: none;"></div>
</div>
<div id="запуск-контейнера" class="section level2" number="8.8">
<h2>
<span class="header-section-number">8.8</span> Запуск контейнера<a class="anchor" aria-label="anchor" href="#%D0%B7%D0%B0%D0%BF%D1%83%D1%81%D0%BA-%D0%BA%D0%BE%D0%BD%D1%82%D0%B5%D0%B9%D0%BD%D0%B5%D1%80%D0%B0"><i class="fas fa-link"></i></a>
</h2>
<p>Итак, теперь у нас уже есть собранный Docker образ с нашим ботом, и нам остаётся запустить его командой <code>docker run</code>. При запуске контейнера вам необходимо указать следующие параметры:</p>
<ol style="list-style-type: decimal">
<li>
<code>--name</code> позволяет задать название контейнера</li>
<li>
<code>-d</code> флаг, который запускает контейнер в фоновом режиме, не блокируя терминал</li>
<li>последним параметром мы задаём имя образа, на основе которого будет запущен контейнер.</li>
</ol>
<pre><code>docker run --name my_bot -d rbot</code></pre>
<div class="inline-figure"><img src="img/8-6.png" border="0" width="630" style="border: none;"></div>
<p>Дополнительно мы могли указать флаг <code>--rm</code>, который автоматически удалит контейнер после его остановки.</p>
<pre><code>docker run --name my_bot -d --rm rbot</code></pre>
</div>
<div id="прокидываем-токен-бота-в-контейнер-при-его-запуске" class="section level2" number="8.9">
<h2>
<span class="header-section-number">8.9</span> Прокидываем токен бота в контейнер при его запуске<a class="anchor" aria-label="anchor" href="#%D0%BF%D1%80%D0%BE%D0%BA%D0%B8%D0%B4%D1%8B%D0%B2%D0%B0%D0%B5%D0%BC-%D1%82%D0%BE%D0%BA%D0%B5%D0%BD-%D0%B1%D0%BE%D1%82%D0%B0-%D0%B2-%D0%BA%D0%BE%D0%BD%D1%82%D0%B5%D0%B9%D0%BD%D0%B5%D1%80-%D0%BF%D1%80%D0%B8-%D0%B5%D0%B3%D0%BE-%D0%B7%D0%B0%D0%BF%D1%83%D1%81%D0%BA%D0%B5"><i class="fas fa-link"></i></a>
</h2>
<p>В примере выше мы указывали токен нашего бота непосредственно в <code>Dockerfile</code> с помощью команды <code>ENV R_TELEGRAM_BOT_botname ТОКЕН_ВАШЕГО_БОТА</code>. Это не всегда удобно, например, вам может понадобиться возможность указывать токен бота непосредственно при запуске контейнера и вам не хочется постоянно редактировать <code>Dockerfile</code>. В таком случае вы можете прокидывать переменные среды при запуске контейнера используя флаг <code>-e</code>.</p>
<p>Вы можете удалить из <code>Dockerfile</code> команду <code>ENV R_TELEGRAM_BOT_botname ТОКЕН_ВАШЕГО_БОТА</code>, и прокинуть эту же переменную непосредственно при запуске контейнера.</p>
<pre><code>docker run --name my_bot -d --rm -e R_TELEGRAM_BOT_botname="ТОКЕН_ВАШЕГО_БОТА" rbot</code></pre>
</div>
<div id="политика-перезапуска-бота" class="section level2" number="8.10">
<h2>
<span class="header-section-number">8.10</span> Политика перезапуска бота<a class="anchor" aria-label="anchor" href="#%D0%BF%D0%BE%D0%BB%D0%B8%D1%82%D0%B8%D0%BA%D0%B0-%D0%BF%D0%B5%D1%80%D0%B5%D0%B7%D0%B0%D0%BF%D1%83%D1%81%D0%BA%D0%B0-%D0%B1%D0%BE%D1%82%D0%B0"><i class="fas fa-link"></i></a>
</h2>
<p>В главе “<a href="%D0%BF%D0%BE%D0%B2%D1%8B%D1%88%D0%B0%D0%B5%D0%BC-%D1%81%D1%82%D0%B0%D0%B1%D0%B8%D0%BB%D1%8C%D0%BD%D0%BE%D1%81%D1%82%D1%8C-%D1%80%D0%B0%D0%B1%D0%BE%D1%82%D1%8B-%D0%B1%D0%BE%D1%82%D0%B0.html#%D0%BF%D0%BE%D0%B2%D1%8B%D1%88%D0%B0%D0%B5%D0%BC-%D1%81%D1%82%D0%B0%D0%B1%D0%B8%D0%BB%D1%8C%D0%BD%D0%BE%D1%81%D1%82%D1%8C-%D1%80%D0%B0%D0%B1%D0%BE%D1%82%D1%8B-%D0%B1%D0%BE%D1%82%D0%B0">Повышаем стабильность работы бота</a>” мы разобрались, как написать бота, который автоматически перезапускается в случае падения.</p>
<p>При запуске бота через docker контейнер, у вас есть отдельная опция <code>--restart</code>, которая позволяет более гибко управлять перезапуском вашего бота. Данная опция принимает одно из следующих значений:</p>
<ul>
<li>
<code>no</code> - Не перезапускать контейнер после завершения. Это значение по умолчанию.</li>
<li>
<code>on-failure[:max-retries]</code> - Перезапускает контейнер если он завершился с не нулевым статусом (т.е. завершился с ошибкой). Опционально можно указать количество попыток перезапуска. Это наиболее подходящая опция для работы бота, т.к. вы можете добавить боту метод остановки пуллинга, и он при запуске команды остановки успешно выключиться, а в случае аварийной остановки - будет перезапущен.</li>
<li>
<code>always</code> - Всегда перезапускает контейнер в не зависимости от статуса завершения. Когда вы выбираете данный вариант, Docker демон будет пытаться перезапустить контейнер бесконечное число раз. Также контейнер будет всегда запускаться при запуске демона, не зависимо от текущего состояния контейнера. В данном случае у вас не будет возможности остановить бота.</li>
<li>
<code>unless-stopped</code> - Всегда перезапускает контейнер не зависимо от статуса завершения, но контейнер не будет запускаться при запуске демона, если контейнер до этого был остановлен вручную.</li>
</ul>
<p>Т.е. следующая команда позволяет запустить бота, который автоматически будет перезапуска в случае ошибки, но при этом, вы в любой момент сможете остановить его любой командой.</p>
<pre><code>docker run --name my_bot -d --rm -e --restart=on-failure rbot</code></pre>
<p>Давайте протестируем команду <code>/crush</code> и <code>/stop</code>, как я уже писал ранее, первая имитирует ошибку в работе бота, вторая же корректно останавливает его работу.</p>
<div class="inline-figure"><img src="img/8-7.png" border="0" width="600" style="border: none;"></div>
<p>Из скрина видно, что даже при выполнении команды <code>/crush</code> вызывающую критическую ошибку и падение бота, сам бот автоматически перезапускается, очищает очередь команд, и продолжает работу.</p>
<p>Команда <code>/stop</code> при этом корректно останавливает работу бота.</p>
</div>
<div id="просмотр-списка-запущенных-контейнеров" class="section level2" number="8.11">
<h2>
<span class="header-section-number">8.11</span> Просмотр списка запущенных контейнеров<a class="anchor" aria-label="anchor" href="#%D0%BF%D1%80%D0%BE%D1%81%D0%BC%D0%BE%D1%82%D1%80-%D1%81%D0%BF%D0%B8%D1%81%D0%BA%D0%B0-%D0%B7%D0%B0%D0%BF%D1%83%D1%89%D0%B5%D0%BD%D0%BD%D1%8B%D1%85-%D0%BA%D0%BE%D0%BD%D1%82%D0%B5%D0%B9%D0%BD%D0%B5%D1%80%D0%BE%D0%B2"><i class="fas fa-link"></i></a>
</h2>
<p>Команда <code>docker ps</code> позволяет посмотреть список запущенных в данный момент контейнеров.</p>
<pre><code>docker ps</code></pre>
<div class="inline-figure"><img src="img/8-8.png" border="0" width="630" style="border: none;"></div>
</div>
<div id="остановка-контейнера" class="section level2" number="8.12">
<h2>
<span class="header-section-number">8.12</span> Остановка контейнера<a class="anchor" aria-label="anchor" href="#%D0%BE%D1%81%D1%82%D0%B0%D0%BD%D0%BE%D0%B2%D0%BA%D0%B0-%D0%BA%D0%BE%D0%BD%D1%82%D0%B5%D0%B9%D0%BD%D0%B5%D1%80%D0%B0"><i class="fas fa-link"></i></a>
</h2>
<p>Для остановки контейнера используйте команду <code>docker stop</code>, передав в качестве единственного аргумента либо id, либо название контейнера, который необходимо остановить, в моём случае равнозначными будет две следующее команды:</p>
<pre><code>docker stop my_bot</code></pre>
<pre><code>docker stop d06f8cebe987</code></pre>
<div class="inline-figure"><img src="img/8-9.png" border="0" width="630" style="border: none;"></div>
</div>
<div id="удаление-контейнера" class="section level2" number="8.13">
<h2>
<span class="header-section-number">8.13</span> Удаление контейнера<a class="anchor" aria-label="anchor" href="#%D1%83%D0%B4%D0%B0%D0%BB%D0%B5%D0%BD%D0%B8%D0%B5-%D0%BA%D0%BE%D0%BD%D1%82%D0%B5%D0%B9%D0%BD%D0%B5%D1%80%D0%B0"><i class="fas fa-link"></i></a>
</h2>
<p>После остановки контейнера с ботом вы можете его удалить командой <code>docker rm</code> передав ей имя контейнера.</p>
<pre><code>docker rm my_bot</code></pre>
<div class="inline-figure"><img src="img/8-10.png" border="0" width="630" style="border: none;"></div>
</div>
<div id="публикация-образа-в-docker-hub" class="section level2" number="8.14">
<h2>
<span class="header-section-number">8.14</span> Публикация образа в Docker hub<a class="anchor" aria-label="anchor" href="#%D0%BF%D1%83%D0%B1%D0%BB%D0%B8%D0%BA%D0%B0%D1%86%D0%B8%D1%8F-%D0%BE%D0%B1%D1%80%D0%B0%D0%B7%D0%B0-%D0%B2-docker-hub"><i class="fas fa-link"></i></a>
</h2>
<p>На данном этапе мы уже разобрались с тем, как устроен Docker, и узнали его основные команды. Но пока мы работали с образами, и запускали контейнеры локально, на ПК на котором мы эти образы собирали. Вся мощь Docker заключается в том, что собранные образы очень легко можно переносить на любой другой ПК, единственное требование - наличие на нём установленного Docker.</p>
<p>Для такого переноса удобно использовать <a href="https://hub.docker.com/">docker-hub</a>, для начала перейдите по ссылке и зарегистрируйтесь там.</p>
<p>Далее возвращаемся в терминал RStudio, логинимся в Docker-hub.</p>
<pre><code>docker login</code></pre>
<p>Далее введите свой логин и пароль, или ключ API вместо пароля. Теперь нам необходимо добавить нужный тег нашему образу для его публикации. Команда <code>tag</code> принимает два аргумента, имя образа, которому надо присвоить тег, и сам тег. Присваиваемый тег должен иметь следующий вид <code>username/repository</code>, т.е. имя пользователя на Docker-hub и название репозитория, куда вы хотите опубликовать образ.</p>
<pre><code>docker tag rbot username/rbot</code></pre>
<p>Следующая команда позволяет опубликовать образ на Docker-hub:</p>
<pre><code>docker push username/rbot</code></pre>
<p>Теперь вы можете загрузить опубликованный ранее образ на любой ПК, независимо от того, какая на нём установлена операционная система, главное предварительно установите на него сам Docker. Используйте следующую команду, что бы забрать образ из Docker-hub:</p>
<pre><code>docker pull username/rbot</code></pre>
<p>После чего образ будет загружен в ваш локальный реестр образов, убедиться в этом можно с помощью команды <code>docker images</code>. Процесс запуска контейнера из загруженного образа ничем не отличается от <a href="%D1%83%D0%BF%D0%B0%D0%BA%D0%BE%D0%B2%D1%8B%D0%B2%D0%B0%D0%B5%D0%BC-%D0%B1%D0%BE%D1%82%D0%B0-%D0%B2-docker-%D0%BA%D0%BE%D0%BD%D1%82%D0%B5%D0%B9%D0%BD%D0%B5%D1%80.html#%D0%B7%D0%B0%D0%BF%D1%83%D1%81%D0%BA-%D0%BA%D0%BE%D0%BD%D1%82%D0%B5%D0%B9%D0%BD%D0%B5%D1%80%D0%B0">описанного выше</a> в этой главе.</p>
<blockquote>
<p>Обратите внимание, если вы планируете опубликовать образ с публичным доступом, то не включайте в <code>Dockerfile</code> секретные данные, такие как токен бота или пароли. Рекомендованным способом передачи секретных данных в контейнер является прокинуть необходимые переменные с этими данными непосредственно при запуске контейнера как описано в разделе <a href="%D1%83%D0%BF%D0%B0%D0%BA%D0%BE%D0%B2%D1%8B%D0%B2%D0%B0%D0%B5%D0%BC-%D0%B1%D0%BE%D1%82%D0%B0-%D0%B2-docker-%D0%BA%D0%BE%D0%BD%D1%82%D0%B5%D0%B9%D0%BD%D0%B5%D1%80.html#%D0%BF%D1%80%D0%BE%D0%BA%D0%B8%D0%B4%D1%8B%D0%B2%D0%B0%D0%B5%D0%BC-%D1%82%D0%BE%D0%BA%D0%B5%D0%BD-%D0%B1%D0%BE%D1%82%D0%B0-%D0%B2-%D0%BA%D0%BE%D0%BD%D1%82%D0%B5%D0%B9%D0%BD%D0%B5%D1%80-%D0%BF%D1%80%D0%B8-%D0%B5%D0%B3%D0%BE-%D0%B7%D0%B0%D0%BF%D1%83%D1%81%D0%BA%D0%B5">Прокидываем токен бота в контейнер при его запуске</a>.</p>
</blockquote>
</div>
<div id="как-создать-общую-папку-для-хранения-файлов" class="section level2" number="8.15">
<h2>
<span class="header-section-number">8.15</span> Как создать общую папку для хранения файлов<a class="anchor" aria-label="anchor" href="#%D0%BA%D0%B0%D0%BA-%D1%81%D0%BE%D0%B7%D0%B4%D0%B0%D1%82%D1%8C-%D0%BE%D0%B1%D1%89%D1%83%D1%8E-%D0%BF%D0%B0%D0%BF%D0%BA%D1%83-%D0%B4%D0%BB%D1%8F-%D1%85%D1%80%D0%B0%D0%BD%D0%B5%D0%BD%D0%B8%D1%8F-%D1%84%D0%B0%D0%B9%D0%BB%D0%BE%D0%B2"><i class="fas fa-link"></i></a>
</h2>
<p>По умолчанию контейнер является полностью изолированным, т.е. все файлы, которые создаются внутри контейнера, удаляются после его запуска, и все данные которые были в эти файлы записаны, также удаляются.</p>
<p>В ходе работы нашего бота пишется лог, сам файл лога <code>bot.log</code> создаётся внутри контейнера в папке <code>log</code>, и за пределами самого контейнера он не доступен. В коде нашего бота за создание лога отвечает следующие команды:</p>
<div class="sourceCode" id="cb92"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://s-fleck.github.io/lgr/">lgr</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Включаем логгер</span></span>
<span><span class="va">lg</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://s-fleck.github.io/lgr/reference/get_logger.html">get_logger</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">lg</span><span class="op">$</span><span class="fu">set_appenders</span><span class="op">(</span><span class="va"><a href="https://s-fleck.github.io/lgr/reference/AppenderFile.html">AppenderFile</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>file <span class="op">=</span> <span class="st">'log/bot.log'</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">lg</span><span class="op">$</span><span class="fu">info</span><span class="op">(</span><span class="st">'Bot start'</span><span class="op">)</span></span></code></pre></div>
<blockquote>
<p>Если вы до этого момента не знакомы с процессом логирования, то рекомендую либо ознакомиться со статьёй “<a href="https://habr.com/ru/post/529118/">Логирование выполнения скриптов на языке R, пакет lgr</a>”, либо видео уроком “<a href="https://www.youtube.com/watch?v=xA8YGxQH1Ws">Логирование процесса выполнения скриптов на языке R (пакеты lgr / lgrExtra)</a>”.</p>
</blockquote>
<p>В данном случае лог пишется в обычный текстовый файл. Но функционал может быть гораздо шире, чем в рассматриваемом нами примере, бот может работать с базой данных, может принимать какие-то файлы. И нам может потребоваться получить доступ к этим данным.</p>
<p>Для того, что бы организовать на вашем ПК общую с каким либо контейнером папку в Docker есть понятие томов - volume. Но при работе на Windows требуется некоторая предварительная подготовка.</p>
<ol style="list-style-type: decimal">
<li>Вместе с <code>Docker toolbox</code> вы установили несколько программ, включая Oracle VM Virtual Box. Запустите её, если у вас возникает ошибка при запуске VirtualBox, то скорее всего вам необходимо перейти по <a href="https://www.virtualbox.org/wiki/Downloads">ссылке</a>, и скачать наиболее актуальную версию.</li>
<li>В Virtual Box выберите дефолтную машину и нажмите “Настроить”:</li>
</ol>
<div class="inline-figure"><img src="img/8-12.png" border="0" width="630" style="border: none;"></div>
<ol start="3" style="list-style-type: decimal">
<li>Перейдите в меню “Общие папки” и создайте новую общую папку прописав ей путь и дав имя. В моём случае сама папка находится по пути <code>D:\packlab\docker_bot\log</code>, и имя для неё я задал <code>d/packlab/docker_bot/log</code>:</li>
</ol>
<div class="inline-figure"><img src="img/8-13.png" border="0" width="630" style="border: none;"></div>
<ol start="4" style="list-style-type: decimal">
<li><p>Теперь вернитесь в терминал RStudio и перезапустите виртуальную машину командой <code>docker-machine restart</code>.</p></li>
<li><p>После перезагрузки, при запуске контейнера используйте флаг <code>-v</code> и укажите через двоеточие соответствие папки на локальном компьютере с папкой в контейнере. В нашем случае папка на локальном компьютере <code>d/packlab/docker_bot/log</code> должна быть связана с папкой <code>/home/bot/log</code> в контейнере. Команда будет выглядеть следующим образом:</p></li>
</ol>
<pre><code>docker run --rm --name my_bot -v //d/packlab/docker_bot/log:/home/bot/log rbot</code></pre>
<p>Обратите внимание, я указал двойной слеш <code>//</code> перед именем папки на локальном компьютере, без этого иногда при запуске контейнера возникает ошибка <code>invalid value "C:\\..." for flag -v: ...:... is not an absolute path</code>.</p>
<p>Сразу после запуска у меня в локальной папке <code>"D:\packlab\docker_bot\log"</code> создаётся файл <code>bot.log</code>, в котором в реальном времени пишется лог работы бота, давайте в этом убедимся:</p>
<div class="inline-figure"><img src="img/8-14.png" border="0" width="600" style="border: none;"></div>
<p>Содержание локального файла <code>bot.log</code>:</p>
<div class="inline-figure"><img src="img/8-15.png" border="0" width="400" style="border: none;"></div>
<p>Отставание на 4 часа между временем в telegram, и файлом лога объясняется тем, что в контейнере по умолчанию установлен другой часовой пояс - UTC.</p>
</div>
<div id="полезные-ссылки" class="section level2" number="8.16">
<h2>
<span class="header-section-number">8.16</span> Полезные ссылки<a class="anchor" aria-label="anchor" href="#%D0%BF%D0%BE%D0%BB%D0%B5%D0%B7%D0%BD%D1%8B%D0%B5-%D1%81%D1%81%D1%8B%D0%BB%D0%BA%D0%B8"><i class="fas fa-link"></i></a>
</h2>
<p>Как я уже писал в начале главы, в интернете полно информации по работе с Docker, тем не менее тут я приведу небольшую подборку ссылок, которые помогут вам получше с ним разобраться:</p>
<ul>
<li><a href="https://youtu.be/QF4ZF857m44">Основы Docker. Большой практический выпуск</a></li>
<li>
<a href="https://colinfay.me/docker-r-reproducibility/">An Introduction to Docker for R Users</a> (англ.)</li>
<li><a href="https://habr.com/ru/post/358774/">Docker под Windows для разработки, разбор подводных камней</a></li>
</ul>
</div>
<div id="заключение-6" class="section level2" number="8.17">
<h2>
<span class="header-section-number">8.17</span> Заключение<a class="anchor" aria-label="anchor" href="#%D0%B7%D0%B0%D0%BA%D0%BB%D1%8E%D1%87%D0%B5%D0%BD%D0%B8%D0%B5-6"><i class="fas fa-link"></i></a>
</h2>
<p>Теперь мы умеем упаковывать telegram ботов в контейнер, что даёт несколько следующих преимуществ:</p>
<ul>
<li>Вы легко можете перенести вашего бота с ноутбука на сервер, или переносить его между серверами, весь процесс займёт пару минут. Никакой предварительной настройки среды для запуска бота теперь не потребуется.</li>
<li>У вас появляется более гибкая возможность управления политикой перезапуска бота.</li>
</ul>
<p>Основные команды docker и их параметры, которые вам понадобятся в ходе упаковки, запуска, публикации и загрузки бота:</p>
<ul>
<li>
<code>docker build</code> - создать образ:
<ul>
<li>
<code>-t</code> - тег образа;</li>
<li>второй аргумент - путь к папке с <code>Dockerfile</code>.</li>
</ul>
</li>
<li>
<code>docker run</code> - запуск контейнера:
<ul>
<li>
<code>--name</code> - имя контейнера;</li>
<li>
<code>-d</code> - запускает контейнер в фоновом режиме;</li>
<li>
<code>--rm</code> - автоматически удаляет контейнер после его остановки;</li>
<li>
<code>-e</code> - создаёт переменную окружения при запуске контейнера;</li>
<li>
<code>--restart</code> - управление политикой перезапуска контейнера;</li>
<li>
<code>-v</code> позволяет прикрепить к контейнеру физическую папку на вашем локальном ПК;</li>
<li>последний аргумент - имя образа на основе которого будет запущен контейнер.</li>
</ul>
</li>
<li>
<code>docker ps</code> - просмотр списка запущенных контейнеров:
<ul>
<li>
<code>-a</code> выводит список всех контейнеров, включая остановленные.</li>
</ul>
</li>
<li>
<code>docker stop</code> - остановка контейнера:
<ul>
<li>в качестве параметра необходимо передать имя или id контейнера.</li>
</ul>
</li>
<li>
<code>docker rm</code> - удаление контейнера:
<ul>
<li>в качестве параметра необходимо передать имя или id контейнера.</li>
</ul>
</li>
<li>
<code>docker login</code> - авторизация в Docker-hub.</li>
<li>
<code>docker tag</code> - добавить тег образу:
<ul>
<li>локальное название образа, которому надо присвоить тег;</li>
<li>название образа в docker-hub по шаблону username/repository.</li>
</ul>
</li>
<li>
<code>docker push</code> - опубликовать образ в docker-hub:
<ul>
<li>название образа в docker-hub по шаблону username/repository.</li>
</ul>
</li>
<li>
<code>docker pull</code> - забрать образ из docker-hub:
<ul>
<li>название образа в docker-hub по шаблону username/repository.</li>
</ul>
</li>
</ul>
</div>
</div>
  <div class="chapter-nav">
<div class="prev"><a href="%D0%B4%D0%BE%D0%B1%D0%B0%D0%B2%D0%BB%D1%8F%D0%B5%D0%BC-%D0%B1%D0%BE%D1%82%D1%83-%D0%B0%D1%81%D0%B8%D0%BD%D1%85%D1%80%D0%BE%D0%BD%D0%BD%D0%BE%D1%81%D1%82%D1%8C.html"><span class="header-section-number">7</span> Добавляем боту асинхронность</a></div>
<div class="next"><a href="%D0%BE%D0%B1%D0%BD%D0%BE%D0%B2%D0%BB%D0%B5%D0%BD%D0%B8%D1%8F.html">Обновления</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#%D1%83%D0%BF%D0%B0%D0%BA%D0%BE%D0%B2%D1%8B%D0%B2%D0%B0%D0%B5%D0%BC-%D0%B1%D0%BE%D1%82%D0%B0-%D0%B2-docker-%D0%BA%D0%BE%D0%BD%D1%82%D0%B5%D0%B9%D0%BD%D0%B5%D1%80"><span class="header-section-number">8</span> Упаковываем бота в Docker контейнер</a></li>
<li><a class="nav-link" href="#%D1%87%D1%82%D0%BE-%D1%82%D0%B0%D0%BA%D0%BE%D0%B5-%D0%B4%D0%BE%D0%BA%D0%B5%D1%80"><span class="header-section-number">8.1</span> Что такое докер</a></li>
<li><a class="nav-link" href="#%D1%83%D1%81%D1%82%D0%B0%D0%BD%D0%BE%D0%B2%D0%BA%D0%B0-docker"><span class="header-section-number">8.2</span> Установка Docker</a></li>
<li><a class="nav-link" href="#%D1%81%D0%BE%D0%B7%D0%B4%D0%B0%D1%91%D0%BC-%D0%BF%D1%80%D0%BE%D0%B5%D0%BA%D1%82-%D0%B2-rstudio"><span class="header-section-number">8.3</span> Создаём проект в RStudio</a></li>
<li><a class="nav-link" href="#%D0%BA%D0%BE%D0%B4-%D0%B1%D0%BE%D1%82%D0%B0"><span class="header-section-number">8.4</span> Код бота</a></li>
<li><a class="nav-link" href="#%D0%BE%D0%B1%D1%80%D0%B0%D0%B7%D1%8B-%D0%B8-%D0%BA%D0%BE%D0%BD%D1%82%D0%B5%D0%B9%D0%BD%D0%B5%D1%80%D1%8B"><span class="header-section-number">8.5</span> Образы и контейнеры</a></li>
<li><a class="nav-link" href="#%D1%81%D0%BE%D0%B7%D0%B4%D0%B0%D0%BD%D0%B8%D0%B5-dockerfile"><span class="header-section-number">8.6</span> Создание Dockerfile</a></li>
<li><a class="nav-link" href="#%D1%81%D0%BE%D0%B7%D0%B4%D0%B0%D0%BD%D0%B8%D0%B5-%D0%BE%D0%B1%D1%80%D0%B0%D0%B7%D0%B0"><span class="header-section-number">8.7</span> Создание образа</a></li>
<li><a class="nav-link" href="#%D0%B7%D0%B0%D0%BF%D1%83%D1%81%D0%BA-%D0%BA%D0%BE%D0%BD%D1%82%D0%B5%D0%B9%D0%BD%D0%B5%D1%80%D0%B0"><span class="header-section-number">8.8</span> Запуск контейнера</a></li>
<li><a class="nav-link" href="#%D0%BF%D1%80%D0%BE%D0%BA%D0%B8%D0%B4%D1%8B%D0%B2%D0%B0%D0%B5%D0%BC-%D1%82%D0%BE%D0%BA%D0%B5%D0%BD-%D0%B1%D0%BE%D1%82%D0%B0-%D0%B2-%D0%BA%D0%BE%D0%BD%D1%82%D0%B5%D0%B9%D0%BD%D0%B5%D1%80-%D0%BF%D1%80%D0%B8-%D0%B5%D0%B3%D0%BE-%D0%B7%D0%B0%D0%BF%D1%83%D1%81%D0%BA%D0%B5"><span class="header-section-number">8.9</span> Прокидываем токен бота в контейнер при его запуске</a></li>
<li><a class="nav-link" href="#%D0%BF%D0%BE%D0%BB%D0%B8%D1%82%D0%B8%D0%BA%D0%B0-%D0%BF%D0%B5%D1%80%D0%B5%D0%B7%D0%B0%D0%BF%D1%83%D1%81%D0%BA%D0%B0-%D0%B1%D0%BE%D1%82%D0%B0"><span class="header-section-number">8.10</span> Политика перезапуска бота</a></li>
<li><a class="nav-link" href="#%D0%BF%D1%80%D0%BE%D1%81%D0%BC%D0%BE%D1%82%D1%80-%D1%81%D0%BF%D0%B8%D1%81%D0%BA%D0%B0-%D0%B7%D0%B0%D0%BF%D1%83%D1%89%D0%B5%D0%BD%D0%BD%D1%8B%D1%85-%D0%BA%D0%BE%D0%BD%D1%82%D0%B5%D0%B9%D0%BD%D0%B5%D1%80%D0%BE%D0%B2"><span class="header-section-number">8.11</span> Просмотр списка запущенных контейнеров</a></li>
<li><a class="nav-link" href="#%D0%BE%D1%81%D1%82%D0%B0%D0%BD%D0%BE%D0%B2%D0%BA%D0%B0-%D0%BA%D0%BE%D0%BD%D1%82%D0%B5%D0%B9%D0%BD%D0%B5%D1%80%D0%B0"><span class="header-section-number">8.12</span> Остановка контейнера</a></li>
<li><a class="nav-link" href="#%D1%83%D0%B4%D0%B0%D0%BB%D0%B5%D0%BD%D0%B8%D0%B5-%D0%BA%D0%BE%D0%BD%D1%82%D0%B5%D0%B9%D0%BD%D0%B5%D1%80%D0%B0"><span class="header-section-number">8.13</span> Удаление контейнера</a></li>
<li><a class="nav-link" href="#%D0%BF%D1%83%D0%B1%D0%BB%D0%B8%D0%BA%D0%B0%D1%86%D0%B8%D1%8F-%D0%BE%D0%B1%D1%80%D0%B0%D0%B7%D0%B0-%D0%B2-docker-hub"><span class="header-section-number">8.14</span> Публикация образа в Docker hub</a></li>
<li><a class="nav-link" href="#%D0%BA%D0%B0%D0%BA-%D1%81%D0%BE%D0%B7%D0%B4%D0%B0%D1%82%D1%8C-%D0%BE%D0%B1%D1%89%D1%83%D1%8E-%D0%BF%D0%B0%D0%BF%D0%BA%D1%83-%D0%B4%D0%BB%D1%8F-%D1%85%D1%80%D0%B0%D0%BD%D0%B5%D0%BD%D0%B8%D1%8F-%D1%84%D0%B0%D0%B9%D0%BB%D0%BE%D0%B2"><span class="header-section-number">8.15</span> Как создать общую папку для хранения файлов</a></li>
<li><a class="nav-link" href="#%D0%BF%D0%BE%D0%BB%D0%B5%D0%B7%D0%BD%D1%8B%D0%B5-%D1%81%D1%81%D1%8B%D0%BB%D0%BA%D0%B8"><span class="header-section-number">8.16</span> Полезные ссылки</a></li>
<li><a class="nav-link" href="#%D0%B7%D0%B0%D0%BA%D0%BB%D1%8E%D1%87%D0%B5%D0%BD%D0%B8%D0%B5-6"><span class="header-section-number">8.17</span> Заключение</a></li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
          
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>Разработка telegram ботов на языке R</strong>" was written by Алексей Селезнёв. It was last built on 2023-01-20.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer>
</body>
</html>

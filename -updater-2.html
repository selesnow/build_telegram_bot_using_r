<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Глава 2 Добавляем боту поддержку команд и фильтры сообщений, класс Updater| Разработка telegram ботов на языке R</title>
  <meta name="description" content="This is a minimal example of using the bookdown package to write a book. The output format for this example is bookdown::gitbook." />
  <meta name="generator" content="bookdown 0.21 and GitBook 2.6.7" />

  <meta property="og:title" content="Глава 2 Добавляем боту поддержку команд и фильтры сообщений, класс Updater| Разработка telegram ботов на языке R" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="This is a minimal example of using the bookdown package to write a book. The output format for this example is bookdown::gitbook." />
  <meta name="github-repo" content="rstudio/bookdown-demo" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Глава 2 Добавляем боту поддержку команд и фильтры сообщений, класс Updater| Разработка telegram ботов на языке R" />
  
  <meta name="twitter:description" content="This is a minimal example of using the bookdown package to write a book. The output format for this example is bookdown::gitbook." />
  

<meta name="author" content="Алексей Селезнёв" />


<meta name="date" content="2020-11-13" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="-telegram-1.html"/>
<link rel="next" href="-3.html"/>
<script src="libs/header-attrs-2.4/header-attrs.js"></script>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />











<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Разработка Telegram ботов на языке R</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Введение</a>
<ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#предисловие"><i class="fa fa-check"></i>Предисловие</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#навыки-необходимые-для-прохождения-учебника"><i class="fa fa-check"></i>Навыки необходимые для прохождения учебника</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#об-авторе"><i class="fa fa-check"></i>Об авторе</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#правки-и-предложения"><i class="fa fa-check"></i>Правки и предложения</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#поддержать-проект"><i class="fa fa-check"></i>Поддержать проект</a></li>
</ul></li>
<li class="chapter" data-level="1" data-path="-telegram-1.html"><a href="-telegram-1.html"><i class="fa fa-check"></i><b>1</b> Создаём бота, и отправляем с его помощью сообщения в telegram</a>
<ul>
<li class="chapter" data-level="1.1" data-path="-telegram-1.html"><a href="-telegram-1.html#создание-телеграм-бота"><i class="fa fa-check"></i><b>1.1</b> Создание телеграм бота</a></li>
<li class="chapter" data-level="1.2" data-path="-telegram-1.html"><a href="-telegram-1.html#установка-пакета-для-работы-с-телеграм-ботом-на-r"><i class="fa fa-check"></i><b>1.2</b> Установка пакета для работы с телеграм ботом на R</a></li>
<li class="chapter" data-level="1.3" data-path="-telegram-1.html"><a href="-telegram-1.html#отправка-сообщений-из-r-в-telegram"><i class="fa fa-check"></i><b>1.3</b> Отправка сообщений из R в Telegram</a></li>
<li class="chapter" data-level="1.4" data-path="-telegram-1.html"><a href="-telegram-1.html#как-отправить-в-telegram-таблицу"><i class="fa fa-check"></i><b>1.4</b> Как отправить в telegram таблицу</a></li>
<li class="chapter" data-level="1.5" data-path="-telegram-1.html"><a href="-telegram-1.html#как-добавить-в-сообщение-emoji"><i class="fa fa-check"></i><b>1.5</b> Как добавить в сообщение Emoji</a></li>
<li class="chapter" data-level="1.6" data-path="-telegram-1.html"><a href="-telegram-1.html#проверка-планировщика-задач-windows-и-отправка-уведомления-о-задачах-работа-которых-была-завершена-аварийно"><i class="fa fa-check"></i><b>1.6</b> Проверка планировщика задач Windows, и отправка уведомления о задачах, работа которых была завершена аварийно</a></li>
<li class="chapter" data-level="1.7" data-path="-telegram-1.html"><a href="-telegram-1.html#настраиваем-расписание-запуска-проверки-задач"><i class="fa fa-check"></i><b>1.7</b> Настраиваем расписание запуска проверки задач</a></li>
<li class="chapter" data-level="1.8" data-path="-telegram-1.html"><a href="-telegram-1.html#заключение"><i class="fa fa-check"></i><b>1.8</b> Заключение</a></li>
<li class="chapter" data-level="1.9" data-path="-telegram-1.html"><a href="-telegram-1.html#тесты-и-задания"><i class="fa fa-check"></i><b>1.9</b> Тесты и задания</a>
<ul>
<li class="chapter" data-level="1.9.1" data-path="-telegram-1.html"><a href="-telegram-1.html#тесты"><i class="fa fa-check"></i><b>1.9.1</b> Тесты</a></li>
<li class="chapter" data-level="1.9.2" data-path="-telegram-1.html"><a href="-telegram-1.html#задания"><i class="fa fa-check"></i><b>1.9.2</b> Задания</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="2" data-path="-updater-2.html"><a href="-updater-2.html"><i class="fa fa-check"></i><b>2</b> Добавляем боту поддержку команд и фильтры сообщений, класс Updater</a>
<ul>
<li class="chapter" data-level="2.1" data-path="-updater-2.html"><a href="-updater-2.html#класс-updater"><i class="fa fa-check"></i><b>2.1</b> Класс Updater</a></li>
<li class="chapter" data-level="2.2" data-path="-updater-2.html"><a href="-updater-2.html#handlers---обработчики"><i class="fa fa-check"></i><b>2.2</b> Handlers - обработчики</a></li>
<li class="chapter" data-level="2.3" data-path="-updater-2.html"><a href="-updater-2.html#добавляем-первую-команду-боту-обработчик-команд"><i class="fa fa-check"></i><b>2.3</b> Добавляем первую команду боту, обработчик команд</a></li>
<li class="chapter" data-level="2.4" data-path="-updater-2.html"><a href="-updater-2.html#обработчик-текстовых-сообщений-и-фильтры"><i class="fa fa-check"></i><b>2.4</b> Обработчик текстовых сообщений и фильтры</a></li>
<li class="chapter" data-level="2.5" data-path="-updater-2.html"><a href="-updater-2.html#добавление-команд-с-параметрами"><i class="fa fa-check"></i><b>2.5</b> Добавление команд с параметрами</a></li>
<li class="chapter" data-level="2.6" data-path="-updater-2.html"><a href="-updater-2.html#запускаем-бота-в-фоновом-режиме"><i class="fa fa-check"></i><b>2.6</b> Запускаем бота в фоновом режиме</a></li>
<li class="chapter" data-level="2.7" data-path="-updater-2.html"><a href="-updater-2.html#как-добавить-бота-в-группу"><i class="fa fa-check"></i><b>2.7</b> Как добавить бота в группу</a></li>
<li class="chapter" data-level="2.8" data-path="-updater-2.html"><a href="-updater-2.html#как-добавить-описание-команд-в-интерфейс-бота"><i class="fa fa-check"></i><b>2.8</b> Как добавить описание команд в интерфейс бота</a></li>
<li class="chapter" data-level="2.9" data-path="-updater-2.html"><a href="-updater-2.html#заключение-1"><i class="fa fa-check"></i><b>2.9</b> Заключение</a></li>
<li class="chapter" data-level="2.10" data-path="-updater-2.html"><a href="-updater-2.html#тесты-и-задания-1"><i class="fa fa-check"></i><b>2.10</b> Тесты и задания</a>
<ul>
<li class="chapter" data-level="2.10.1" data-path="-updater-2.html"><a href="-updater-2.html#тесты-1"><i class="fa fa-check"></i><b>2.10.1</b> Тесты</a></li>
<li class="chapter" data-level="2.10.2" data-path="-updater-2.html"><a href="-updater-2.html#задания-1"><i class="fa fa-check"></i><b>2.10.2</b> Задания</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="3" data-path="-3.html"><a href="-3.html"><i class="fa fa-check"></i><b>3</b> Как добавить боту поддержку клавиатуры</a>
<ul>
<li class="chapter" data-level="3.1" data-path="-3.html"><a href="-3.html#какие-типы-клавиатур-поддерживает-телеграм-бот"><i class="fa fa-check"></i><b>3.1</b> Какие типы клавиатур поддерживает телеграм бот</a></li>
<li class="chapter" data-level="3.2" data-path="-3.html"><a href="-3.html#reply-клавиатура"><i class="fa fa-check"></i><b>3.2</b> Reply клавиатура</a></li>
<li class="chapter" data-level="3.3" data-path="-3.html"><a href="-3.html#inline-клавиатура"><i class="fa fa-check"></i><b>3.3</b> Inline клавиатура</a>
<ul>
<li class="chapter" data-level="3.3.1" data-path="-3.html"><a href="-3.html#пример-простейшего-бота-с-поддержкой-inline-кнопок"><i class="fa fa-check"></i><b>3.3.1</b> Пример простейшего бота с поддержкой InLine кнопок</a></li>
<li class="chapter" data-level="3.3.2" data-path="-3.html"><a href="-3.html#пример-бота-который-сообщает-текущую-погоду-по-выбранному-городу"><i class="fa fa-check"></i><b>3.3.2</b> Пример бота, который сообщает текущую погоду по выбранному городу</a></li>
<li class="chapter" data-level="3.3.3" data-path="-3.html"><a href="-3.html#пример-бота-который-выводит-список-самых-свежих-статей-со-ссылками-по-указанному-хабу-из-habr.com."><i class="fa fa-check"></i><b>3.3.3</b> Пример бота, который выводит список самых свежих статей со ссылками по-указанному Хабу из <span>habr.com</span>.</a></li>
</ul></li>
<li class="chapter" data-level="3.4" data-path="-3.html"><a href="-3.html#заключение-2"><i class="fa fa-check"></i><b>3.4</b> Заключение</a></li>
<li class="chapter" data-level="3.5" data-path="-3.html"><a href="-3.html#тесты-и-задания-2"><i class="fa fa-check"></i><b>3.5</b> Тесты и задания</a>
<ul>
<li class="chapter" data-level="3.5.1" data-path="-3.html"><a href="-3.html#тесты-2"><i class="fa fa-check"></i><b>3.5.1</b> Тесты</a></li>
<li class="chapter" data-level="3.5.2" data-path="-3.html"><a href="-3.html#задания-2"><i class="fa fa-check"></i><b>3.5.2</b> Задания</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="4" data-path="-4.html"><a href="-4.html"><i class="fa fa-check"></i><b>4</b> Построение последовательного, логического диалога с ботом</a>
<ul>
<li class="chapter" data-level="4.1" data-path="-4.html"><a href="-4.html#введение-1"><i class="fa fa-check"></i><b>4.1</b> Введение</a></li>
<li class="chapter" data-level="4.2" data-path="-4.html"><a href="-4.html#процесс-построения-бота"><i class="fa fa-check"></i><b>4.2</b> Процесс построения бота</a></li>
<li class="chapter" data-level="4.3" data-path="-4.html"><a href="-4.html#структура-проекта-бота"><i class="fa fa-check"></i><b>4.3</b> Структура проекта бота</a></li>
<li class="chapter" data-level="4.4" data-path="-4.html"><a href="-4.html#конфиг-бота"><i class="fa fa-check"></i><b>4.4</b> Конфиг бота</a></li>
<li class="chapter" data-level="4.5" data-path="-4.html"><a href="-4.html#создаём-переменную-среды"><i class="fa fa-check"></i><b>4.5</b> Создаём переменную среды</a></li>
<li class="chapter" data-level="4.6" data-path="-4.html"><a href="-4.html#создаём-базу-данных"><i class="fa fa-check"></i><b>4.6</b> Создаём базу данных</a></li>
<li class="chapter" data-level="4.7" data-path="-4.html"><a href="-4.html#пишем-функции-для-работы-с-базой-данных"><i class="fa fa-check"></i><b>4.7</b> Пишем функции для работы с базой данных</a></li>
<li class="chapter" data-level="4.8" data-path="-4.html"><a href="-4.html#методы-бота"><i class="fa fa-check"></i><b>4.8</b> Методы бота</a></li>
<li class="chapter" data-level="4.9" data-path="-4.html"><a href="-4.html#фильтры-сообщений"><i class="fa fa-check"></i><b>4.9</b> Фильтры сообщений</a></li>
<li class="chapter" data-level="4.10" data-path="-4.html"><a href="-4.html#обработчики"><i class="fa fa-check"></i><b>4.10</b> Обработчики</a></li>
<li class="chapter" data-level="4.11" data-path="-4.html"><a href="-4.html#код-запуска-бота"><i class="fa fa-check"></i><b>4.11</b> Код запуска бота</a></li>
<li class="chapter" data-level="4.12" data-path="-4.html"><a href="-4.html#заключение-3"><i class="fa fa-check"></i><b>4.12</b> Заключение</a></li>
<li class="chapter" data-level="4.13" data-path="-4.html"><a href="-4.html#тесты-и-задания-3"><i class="fa fa-check"></i><b>4.13</b> Тесты и задания</a>
<ul>
<li class="chapter" data-level="4.13.1" data-path="-4.html"><a href="-4.html#тесты-3"><i class="fa fa-check"></i><b>4.13.1</b> Тесты</a></li>
<li class="chapter" data-level="4.13.2" data-path="-4.html"><a href="-4.html#задания-3"><i class="fa fa-check"></i><b>4.13.2</b> Задания</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="5" data-path="-5.html"><a href="-5.html"><i class="fa fa-check"></i><b>5</b> Управление правами пользователей бота</a>
<ul>
<li class="chapter" data-level="5.1" data-path="-5.html"><a href="-5.html#введение-2"><i class="fa fa-check"></i><b>5.1</b> Введение</a></li>
<li class="chapter" data-level="5.2" data-path="-5.html"><a href="-5.html#ограничиваем-права-пользователя-с-помощью-фильтров-сообщений"><i class="fa fa-check"></i><b>5.2</b> Ограничиваем права пользователя с помощью фильтров сообщений</a>
<ul>
<li class="chapter" data-level="5.2.1" data-path="-5.html"><a href="-5.html#ограничиваем-права-на-уровне-имени-пользователя"><i class="fa fa-check"></i><b>5.2.1</b> Ограничиваем права на уровне имени пользователя</a></li>
<li class="chapter" data-level="5.2.2" data-path="-5.html"><a href="-5.html#ограничиваем-права-на-уровне-чата"><i class="fa fa-check"></i><b>5.2.2</b> Ограничиваем права на уровне чата</a></li>
</ul></li>
<li class="chapter" data-level="5.3" data-path="-5.html"><a href="-5.html#ограничиваем-права-пользователя-внутри-кода-методов"><i class="fa fa-check"></i><b>5.3</b> Ограничиваем права пользователя внутри кода методов</a>
<ul>
<li class="chapter" data-level="5.3.1" data-path="-5.html"><a href="-5.html#ограничиваем-права-на-уровне-имени-пользователя-1"><i class="fa fa-check"></i><b>5.3.1</b> Ограничиваем права на уровне имени пользователя</a></li>
<li class="chapter" data-level="5.3.2" data-path="-5.html"><a href="-5.html#ограничиваем-права-на-уровне-чата-1"><i class="fa fa-check"></i><b>5.3.2</b> Ограничиваем права на уровне чата</a></li>
</ul></li>
<li class="chapter" data-level="5.4" data-path="-5.html"><a href="-5.html#заключение-4"><i class="fa fa-check"></i><b>5.4</b> Заключение</a></li>
<li class="chapter" data-level="5.5" data-path="-5.html"><a href="-5.html#тесты-и-задания-4"><i class="fa fa-check"></i><b>5.5</b> Тесты и задания</a>
<ul>
<li class="chapter" data-level="5.5.1" data-path="-5.html"><a href="-5.html#тесты-4"><i class="fa fa-check"></i><b>5.5.1</b> Тесты</a></li>
<li class="chapter" data-level="5.5.2" data-path="-5.html"><a href="-5.html#задания-4"><i class="fa fa-check"></i><b>5.5.2</b> Задания</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="6" data-path="-6.html"><a href="-6.html"><i class="fa fa-check"></i><b>6</b> Повышаем стабильность работы бота</a>
<ul>
<li class="chapter" data-level="6.1" data-path="-6.html"><a href="-6.html#конструкция-trycatch"><i class="fa fa-check"></i><b>6.1</b> Конструкция tryCatch()</a></li>
<li class="chapter" data-level="6.2" data-path="-6.html"><a href="-6.html#логика-работы-конструкции-trycatch"><i class="fa fa-check"></i><b>6.2</b> Логика работы конструкции tryCatch()</a></li>
<li class="chapter" data-level="6.3" data-path="-6.html"><a href="-6.html#используем-trycatch-внутри-бота"><i class="fa fa-check"></i><b>6.3</b> Используем tryCatch() внутри бота</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="-tasks.html"><a href="-tasks.html"><i class="fa fa-check"></i>Решение задач</a>
<ul>
<li class="chapter" data-level="" data-path="-tasks.html"><a href="-tasks.html#задача-1.1"><i class="fa fa-check"></i>Задача 1.1</a></li>
<li class="chapter" data-level="" data-path="-tasks.html"><a href="-tasks.html#задача-2.1"><i class="fa fa-check"></i>Задача 2.1</a></li>
<li class="chapter" data-level="" data-path="-tasks.html"><a href="-tasks.html#задача-3.1"><i class="fa fa-check"></i>Задача 3.1</a></li>
<li class="chapter" data-level="" data-path="-tasks.html"><a href="-tasks.html#задача-4.1"><i class="fa fa-check"></i>Задача 4.1</a></li>
<li class="chapter" data-level="" data-path="-tasks.html"><a href="-tasks.html#задача-5.1"><i class="fa fa-check"></i>Задача 5.1</a></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://t.me/R4marketing" target="blank">Канал R4marketing</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Разработка telegram ботов на языке R</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="добавляем-боту-поддержку-команд-и-фильтры-сообщений-класс-updater-2" class="section level1" number="2">
<h1><span class="header-section-number">Глава 2</span> Добавляем боту поддержку команд и фильтры сообщений, класс Updater</h1>
<p>В этой главе мы разберёмся как оживить нашего бота и добавим ему поддержку команд, а также познакомимся с классом <code>Updater</code>.</p>
<p>В ходе главы мы напишем нескольких простых ботов, последний будет по заданной дате и коду страны определять является ли день в данной стране выходным или рабочим согласно производственного календаря. Но, как и прежде цель книги ознакомить вас с интерфейсом пакета <code>telegram.bot</code> для решения ваших собственных задач.</p>
<p><img src="https://habrastorage.org/webt/qu/zh/a1/quzha12axnh68qnfap4yo1jbevm.png" align="center" width="80%" /></p>
<div id="класс-updater" class="section level2" number="2.1">
<h2><span class="header-section-number">2.1</span> Класс Updater</h2>
<p><code>Updater</code> - это класс, который упрощает вам разработку телеграм бота, и использует под капотом класс <code>Dispetcher</code>. Назначение класса <code>Updater</code> заключается в том, что бы получить обновления от бота (в предыдущей главе мы использовали для этой цели метод <code>getUpdates()</code>), и передать их далее в <code>Dispetcher</code>.</p>
<p>В свою очередь <code>Dispetcher</code> содержит в себе созданные вами обработчики, т.е. объекты класса <code>Handler</code>.</p>
</div>
<div id="handlers---обработчики" class="section level2" number="2.2">
<h2><span class="header-section-number">2.2</span> Handlers - обработчики</h2>
<p>С помощью обработчиков вы добавляете в <code>Dispetcher</code> реакции бота на различные события. На момент написания книги в <code>telegram.bot</code> добавлены следующие типы обработчиков:</p>
<ul>
<li>MessageHandler - Обработчик сообщений</li>
<li>CommandHandler - Обработчик команд</li>
<li>CallbackQueryHandler - Обработчик данных отправляемых из Inline клавиатур</li>
<li>ErrorHandler - Обработчик ошибок при запросе обновлений от бота</li>
</ul>
</div>
<div id="добавляем-первую-команду-боту-обработчик-команд" class="section level2" number="2.3">
<h2><span class="header-section-number">2.3</span> Добавляем первую команду боту, обработчик команд</h2>
<p>Если вы никогда ранее не использовали ботов, и не в курсе, что такое команда, то команды боту необходимо отправлять с помощью прямого слеша <code>/</code> в качестве префикса.</p>
<p>Начнём мы с простых команд, т.е. научим нашего бота здороваться по команде <code>/hi</code>.</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb22-1"><a href="-updater-2.html#cb22-1" aria-hidden="true"></a><span class="kw">library</span>(telegram.bot)</span>
<span id="cb22-2"><a href="-updater-2.html#cb22-2" aria-hidden="true"></a></span>
<span id="cb22-3"><a href="-updater-2.html#cb22-3" aria-hidden="true"></a><span class="co"># создаём экземпляр класса Updater</span></span>
<span id="cb22-4"><a href="-updater-2.html#cb22-4" aria-hidden="true"></a>updater &lt;-<span class="st"> </span><span class="kw">Updater</span>(<span class="st">&#39;ТОКЕН ВАШЕГО БОТА&#39;</span>)</span>
<span id="cb22-5"><a href="-updater-2.html#cb22-5" aria-hidden="true"></a></span>
<span id="cb22-6"><a href="-updater-2.html#cb22-6" aria-hidden="true"></a><span class="co"># Пишем метод для приветсвия</span></span>
<span id="cb22-7"><a href="-updater-2.html#cb22-7" aria-hidden="true"></a>say_hello &lt;-<span class="st"> </span><span class="cf">function</span>(bot, update) {</span>
<span id="cb22-8"><a href="-updater-2.html#cb22-8" aria-hidden="true"></a></span>
<span id="cb22-9"><a href="-updater-2.html#cb22-9" aria-hidden="true"></a>  <span class="co"># Имя пользователя с которым надо поздароваться</span></span>
<span id="cb22-10"><a href="-updater-2.html#cb22-10" aria-hidden="true"></a>  user_name &lt;-<span class="st"> </span>update<span class="op">$</span>message<span class="op">$</span>from<span class="op">$</span>first_name</span>
<span id="cb22-11"><a href="-updater-2.html#cb22-11" aria-hidden="true"></a></span>
<span id="cb22-12"><a href="-updater-2.html#cb22-12" aria-hidden="true"></a>  <span class="co"># Отправка приветственного сообщения</span></span>
<span id="cb22-13"><a href="-updater-2.html#cb22-13" aria-hidden="true"></a>  bot<span class="op">$</span><span class="kw">sendMessage</span>(update<span class="op">$</span>message<span class="op">$</span>chat_id,</span>
<span id="cb22-14"><a href="-updater-2.html#cb22-14" aria-hidden="true"></a>                  <span class="dt">text =</span> <span class="kw">paste0</span>(<span class="st">&quot;Моё почтение, &quot;</span>, user_name, <span class="st">&quot;!&quot;</span>),</span>
<span id="cb22-15"><a href="-updater-2.html#cb22-15" aria-hidden="true"></a>                  <span class="dt">parse_mode =</span> <span class="st">&quot;Markdown&quot;</span>)</span>
<span id="cb22-16"><a href="-updater-2.html#cb22-16" aria-hidden="true"></a></span>
<span id="cb22-17"><a href="-updater-2.html#cb22-17" aria-hidden="true"></a>}</span>
<span id="cb22-18"><a href="-updater-2.html#cb22-18" aria-hidden="true"></a></span>
<span id="cb22-19"><a href="-updater-2.html#cb22-19" aria-hidden="true"></a><span class="co"># создаём обработчик</span></span>
<span id="cb22-20"><a href="-updater-2.html#cb22-20" aria-hidden="true"></a>hi_hendler &lt;-<span class="st"> </span><span class="kw">CommandHandler</span>(<span class="st">&#39;hi&#39;</span>, say_hello)</span>
<span id="cb22-21"><a href="-updater-2.html#cb22-21" aria-hidden="true"></a></span>
<span id="cb22-22"><a href="-updater-2.html#cb22-22" aria-hidden="true"></a><span class="co"># добаляем обработчик в диспетчер</span></span>
<span id="cb22-23"><a href="-updater-2.html#cb22-23" aria-hidden="true"></a>updater &lt;-<span class="st"> </span>updater <span class="op">+</span><span class="st"> </span>hi_hendler</span>
<span id="cb22-24"><a href="-updater-2.html#cb22-24" aria-hidden="true"></a></span>
<span id="cb22-25"><a href="-updater-2.html#cb22-25" aria-hidden="true"></a><span class="co"># запускаем бота</span></span>
<span id="cb22-26"><a href="-updater-2.html#cb22-26" aria-hidden="true"></a>updater<span class="op">$</span><span class="kw">start_polling</span>()</span></code></pre></div>
<blockquote>
<p>Запустите приведённый выше пример кода, предварительно заменив ‘ТОКЕН ВАШЕГО БОТА’ на реальный токен, который вы получили при создании бота через <em>BotFather</em>.</p>
</blockquote>
<p>Метод <code>start_polling()</code> класса <code>Updater</code>, который используется в конце кода, запускает бесконечный цикл запроса и обработки обновлений от бота.</p>
<p>Теперь откроем телеграм, и напишем нашему боту первую команду <code>/hi</code>.</p>
<p><img src="http://img.netpeak.ua/alsey/159742442588_kiss_208kb.png" /></p>
<p>Теперь наш бот понимает команду <code>/hi</code>, и умеет с нами здороваться.</p>
<p>Схематически процесс построения такого простейшего бота можно изобразить следующим образом.</p>
<p><img src="http://img.netpeak.ua/alsey/159742510212_kiss_21kb.png" /></p>
<ol style="list-style-type: decimal">
<li>Создаём экземпляр класса <code>Updater</code>;</li>
<li>Создаём методы, т.е. функции которые будет выполнять наш бот. В примере кода это функция <code>say_hello()</code>. Функции, которые вами будут использоваться как методы бота должны иметь два обязательных аргумента - <em>bot</em> и <em>update</em>, и один необязательный - <em>args</em>. Аргумент <em>bot</em>, это и есть ваш бот, с его помощью вы можете отвечать на сообщения, отправлять сообщения, или использовать любые другие доступные боту методы. Аргумент <em>update</em> это то, что бот получил от пользователя, по сути, то что в первой главе мы получали методом <code>getUpdates()</code>. Аргумент <em>args</em> позволяет вам обрабатывать дополнительные данные отправленные пользователем вместе с командой, к этой теме мы ещё вернёмся немного позже;</li>
<li>Создаём обработчики, т.е. связываем какие-то действия пользователя с созданными на прошлом шаге методами. По сути обработчик это триггер, событие которое вызывает какую-то функцию бота. В нашем примере таким триггером является отправка команды <code>/hi</code>, и реализуется командой <code>hi_hendler &lt;- CommandHandler('hi', say_hello)</code>. Первый аргумент функции <code>CommandHandler()</code> позволяет вам задать команду, в нашем случае <code>hi</code>, на которую будет реагировать бот. Второй аргумент позволяет указать метод бота, мы будем вызывать метод <code>say_hello</code>, который будет выполняться если пользователь вызвал указанную в первом аргументе команду;</li>
<li>Далее добавляем созданный обработчик в диспетчер нашего экземпляра класса <code>Updater</code>. Добавлять обработчики можно несколькими способами, в примере выше я использовал простейший, с помощью знака <code>+</code>, т.е. <code>updater &lt;- updater + hi_hendler</code>. То же самое можно сделать с помощью метода <code>add_handler()</code>, который относится к классу <code>Dispatcher</code>, найти этот метод можно так: <code>updater$dispatcher$add_handler()</code>;</li>
<li>Запускаем бота с помощью команды <code>start_polling()</code>.</li>
</ol>
</div>
<div id="обработчик-текстовых-сообщений-и-фильтры" class="section level2" number="2.4">
<h2><span class="header-section-number">2.4</span> Обработчик текстовых сообщений и фильтры</h2>
<p>Как отправлять боту команды мы разобрались, но иногда нам требуется, что бы бот реагировал не только на команды, но и на какие-то обычные, текстовые сообщения. Для этого необходимо использовать обработчики сообщений - <strong>MessageHandler</strong>.</p>
<p>Обычный <strong>MessageHandler</strong> будет реагировать на абсолютно все входящие сообщения. Поэтому зачастую обработчики сообщений используются вместе с фильтрами. Давайте научим бота здороваться не только по команде <code>/hi</code>, но и всегда, когда в сообщении отправленном боту встречается одно из следующих слов: привет, здравствуй, салют, хай, бонжур.</p>
<p>Пока мы не будем писать какие-то новые методы, т.к. у нас уже есть метод с помощью которого бот с нами здоровается. От нас требуется только создать нужный фильтр и обработчик сообщений.</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb23-1"><a href="-updater-2.html#cb23-1" aria-hidden="true"></a><span class="kw">library</span>(telegram.bot)</span>
<span id="cb23-2"><a href="-updater-2.html#cb23-2" aria-hidden="true"></a></span>
<span id="cb23-3"><a href="-updater-2.html#cb23-3" aria-hidden="true"></a><span class="co"># создаём экземпляр класса Updater</span></span>
<span id="cb23-4"><a href="-updater-2.html#cb23-4" aria-hidden="true"></a>updater &lt;-<span class="st"> </span><span class="kw">Updater</span>(<span class="st">&#39;ТОКЕН ВАШЕГО БОТА&#39;</span>)</span>
<span id="cb23-5"><a href="-updater-2.html#cb23-5" aria-hidden="true"></a></span>
<span id="cb23-6"><a href="-updater-2.html#cb23-6" aria-hidden="true"></a><span class="co"># Пишем метод для приветсвия</span></span>
<span id="cb23-7"><a href="-updater-2.html#cb23-7" aria-hidden="true"></a><span class="co">## команда приветвия</span></span>
<span id="cb23-8"><a href="-updater-2.html#cb23-8" aria-hidden="true"></a>say_hello &lt;-<span class="st"> </span><span class="cf">function</span>(bot, update) {</span>
<span id="cb23-9"><a href="-updater-2.html#cb23-9" aria-hidden="true"></a></span>
<span id="cb23-10"><a href="-updater-2.html#cb23-10" aria-hidden="true"></a>  <span class="co"># Имя пользователя с которым надо поздароваться</span></span>
<span id="cb23-11"><a href="-updater-2.html#cb23-11" aria-hidden="true"></a>  user_name &lt;-<span class="st"> </span>update<span class="op">$</span>message<span class="op">$</span>from<span class="op">$</span>first_name</span>
<span id="cb23-12"><a href="-updater-2.html#cb23-12" aria-hidden="true"></a></span>
<span id="cb23-13"><a href="-updater-2.html#cb23-13" aria-hidden="true"></a>  <span class="co"># Отправляем приветсвенное сообщение</span></span>
<span id="cb23-14"><a href="-updater-2.html#cb23-14" aria-hidden="true"></a>  bot<span class="op">$</span><span class="kw">sendMessage</span>(update<span class="op">$</span>message<span class="op">$</span>chat_id,</span>
<span id="cb23-15"><a href="-updater-2.html#cb23-15" aria-hidden="true"></a>                  <span class="dt">text =</span> <span class="kw">paste0</span>(<span class="st">&quot;Моё почтение, &quot;</span>, user_name, <span class="st">&quot;!&quot;</span>),</span>
<span id="cb23-16"><a href="-updater-2.html#cb23-16" aria-hidden="true"></a>                  <span class="dt">parse_mode =</span> <span class="st">&quot;Markdown&quot;</span>,</span>
<span id="cb23-17"><a href="-updater-2.html#cb23-17" aria-hidden="true"></a>                  <span class="dt">reply_to_message_id =</span> update<span class="op">$</span>message<span class="op">$</span>message_id)</span>
<span id="cb23-18"><a href="-updater-2.html#cb23-18" aria-hidden="true"></a></span>
<span id="cb23-19"><a href="-updater-2.html#cb23-19" aria-hidden="true"></a>}</span>
<span id="cb23-20"><a href="-updater-2.html#cb23-20" aria-hidden="true"></a></span>
<span id="cb23-21"><a href="-updater-2.html#cb23-21" aria-hidden="true"></a><span class="co"># создаём фильтры</span></span>
<span id="cb23-22"><a href="-updater-2.html#cb23-22" aria-hidden="true"></a>MessageFilters<span class="op">$</span>hi &lt;-<span class="st"> </span><span class="kw">BaseFilter</span>(<span class="cf">function</span>(message) {</span>
<span id="cb23-23"><a href="-updater-2.html#cb23-23" aria-hidden="true"></a></span>
<span id="cb23-24"><a href="-updater-2.html#cb23-24" aria-hidden="true"></a>  <span class="co"># проверяем, встречается ли в тексте сообщения слова: привет, здравствуй, салют, хай, бонжур</span></span>
<span id="cb23-25"><a href="-updater-2.html#cb23-25" aria-hidden="true"></a>  <span class="kw">grepl</span>(<span class="dt">x           =</span> message<span class="op">$</span>text,</span>
<span id="cb23-26"><a href="-updater-2.html#cb23-26" aria-hidden="true"></a>        <span class="dt">pattern     =</span> <span class="st">&#39;привет|здравствуй|салют|хай|бонжур&#39;</span>,</span>
<span id="cb23-27"><a href="-updater-2.html#cb23-27" aria-hidden="true"></a>        <span class="dt">ignore.case =</span> <span class="ot">TRUE</span>)</span>
<span id="cb23-28"><a href="-updater-2.html#cb23-28" aria-hidden="true"></a>  }</span>
<span id="cb23-29"><a href="-updater-2.html#cb23-29" aria-hidden="true"></a>)</span>
<span id="cb23-30"><a href="-updater-2.html#cb23-30" aria-hidden="true"></a></span>
<span id="cb23-31"><a href="-updater-2.html#cb23-31" aria-hidden="true"></a><span class="co"># создаём обработчик</span></span>
<span id="cb23-32"><a href="-updater-2.html#cb23-32" aria-hidden="true"></a>hi_hendler &lt;-<span class="st"> </span><span class="kw">CommandHandler</span>(<span class="st">&#39;hi&#39;</span>, say_hello) <span class="co"># обработчик команды hi</span></span>
<span id="cb23-33"><a href="-updater-2.html#cb23-33" aria-hidden="true"></a>hi_txt_hnd &lt;-<span class="st"> </span><span class="kw">MessageHandler</span>(say_hello, <span class="dt">filters =</span> MessageFilters<span class="op">$</span>hi)</span>
<span id="cb23-34"><a href="-updater-2.html#cb23-34" aria-hidden="true"></a></span>
<span id="cb23-35"><a href="-updater-2.html#cb23-35" aria-hidden="true"></a><span class="co"># добаляем обработчики в диспетчер</span></span>
<span id="cb23-36"><a href="-updater-2.html#cb23-36" aria-hidden="true"></a>updater &lt;-<span class="st"> </span>updater <span class="op">+</span></span>
<span id="cb23-37"><a href="-updater-2.html#cb23-37" aria-hidden="true"></a><span class="st">             </span>hi_hendler <span class="op">+</span></span>
<span id="cb23-38"><a href="-updater-2.html#cb23-38" aria-hidden="true"></a><span class="st">             </span>hi_txt_hnd</span>
<span id="cb23-39"><a href="-updater-2.html#cb23-39" aria-hidden="true"></a></span>
<span id="cb23-40"><a href="-updater-2.html#cb23-40" aria-hidden="true"></a><span class="co"># запускаем бота</span></span>
<span id="cb23-41"><a href="-updater-2.html#cb23-41" aria-hidden="true"></a>updater<span class="op">$</span><span class="kw">start_polling</span>()</span></code></pre></div>
<blockquote>
<p>Запустите приведённый выше пример кода, предварительно заменив ‘ТОКЕН ВАШЕГО БОТА’ на реальный токен, который вы получили при создании бота через <em>BotFather</em>.</p>
</blockquote>
<p>Теперь попробуем отправить боту несколько сообщений, в которых будут встречаться перечисленные ранее слова приветствия:
<img src="https://img.netpeak.ua/alsey/159787794513_kiss_226kb.png" /></p>
<p>Итак, в первую очередь мы научили бота не просто здороваться, а отвечать на приветствие. Сделали мы это с помощью аргумента <em>reply_to_message_id</em>, который доступен в методе <code>sendMessage()</code>, в который необходимо передать id сообщения на которое требуется ответить. Получить id сообщения можно вот так: <code>update$message$message_id</code>.</p>
<p>Но главное, что мы сделали - добавили боту фильтр с помощью функции <code>BaseFilter()</code>:</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb24-1"><a href="-updater-2.html#cb24-1" aria-hidden="true"></a><span class="co"># создаём фильтры</span></span>
<span id="cb24-2"><a href="-updater-2.html#cb24-2" aria-hidden="true"></a>MessageFilters<span class="op">$</span>hi &lt;-<span class="st"> </span><span class="kw">BaseFilter</span>(</span>
<span id="cb24-3"><a href="-updater-2.html#cb24-3" aria-hidden="true"></a></span>
<span id="cb24-4"><a href="-updater-2.html#cb24-4" aria-hidden="true"></a>  <span class="co"># анонимная фильтрующая функция</span></span>
<span id="cb24-5"><a href="-updater-2.html#cb24-5" aria-hidden="true"></a>  <span class="cf">function</span>(message) {</span>
<span id="cb24-6"><a href="-updater-2.html#cb24-6" aria-hidden="true"></a></span>
<span id="cb24-7"><a href="-updater-2.html#cb24-7" aria-hidden="true"></a>    <span class="co"># проверяем, встречается ли в тексте сообщения слова приветствия</span></span>
<span id="cb24-8"><a href="-updater-2.html#cb24-8" aria-hidden="true"></a>    <span class="kw">grepl</span>(<span class="dt">x           =</span> message<span class="op">$</span>text,</span>
<span id="cb24-9"><a href="-updater-2.html#cb24-9" aria-hidden="true"></a>          <span class="dt">pattern     =</span> <span class="st">&#39;привет|здравствуй|салют|хай|бонжур&#39;</span>,</span>
<span id="cb24-10"><a href="-updater-2.html#cb24-10" aria-hidden="true"></a>          <span class="dt">ignore.case =</span> <span class="ot">TRUE</span>)</span>
<span id="cb24-11"><a href="-updater-2.html#cb24-11" aria-hidden="true"></a>  }</span>
<span id="cb24-12"><a href="-updater-2.html#cb24-12" aria-hidden="true"></a></span>
<span id="cb24-13"><a href="-updater-2.html#cb24-13" aria-hidden="true"></a>)</span></code></pre></div>
<p>Как вы могли заметить, фильтры необходимо добавлять в объект <strong>MessageFilters</strong>, в котором изначально уже есть небольшой набор готовых фильтров. В нашем примере в объект <strong>MessageFilters</strong> мы добавили элемент <em>hi</em>, это новый фильтр.</p>
<p>В функцию <code>BaseFilter()</code> вам необходимо передать фильтрующую функцию. По сути, фильтр - это просто функция, которая получает экземпляр сообщения и возвращает <em>TRUE</em> или <em>FALSE</em>. В нашем примере, мы написали простейшую функцию, которая с помощью базовой функции <code>grepl()</code> проверяет текст сообщения, и если он соответствует регулярному выражению <code>привет|здравствуй|салют|хай|бонжур</code> возвращает <em>TRUE</em>.</p>
<p>Далее мы создаём обработчик сообщений <code>hi_txt_hnd &lt;- MessageHandler(say_hello, filters = MessageFilters$hi)</code>. Первый аргумент функции <code>MessageHandler()</code> - метод, который будет вызывать обработчик, а второй аргумент - это фильтр по которому он будет вызываться. В нашем случае это созданный нами фильтр <code>MessageFilters$hi</code>.</p>
<p>Ну и в итоге, мы добавляем в диспетчер созданный только, что обработчик <em>hi_txt_hnd</em>.</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb25-1"><a href="-updater-2.html#cb25-1" aria-hidden="true"></a>updater &lt;-<span class="st"> </span>updater <span class="op">+</span></span>
<span id="cb25-2"><a href="-updater-2.html#cb25-2" aria-hidden="true"></a><span class="st">             </span>hi_hendler <span class="op">+</span></span>
<span id="cb25-3"><a href="-updater-2.html#cb25-3" aria-hidden="true"></a><span class="st">             </span>hi_txt_hnd</span></code></pre></div>
<p>Как я уже писал выше, в пакете <code>telegram.bot</code> и объекте <strong>MessageFilters</strong> уже есть набор встроенных фильтров, которые вы можете использовать:</p>
<ul>
<li>all - Все сообщения</li>
<li>text - Текстовые сообщения</li>
<li>command - Команды, т.е. сообщения которые начинаются на <code>/</code></li>
<li>reply - Сообщения, которые являются ответом на другое сообщение</li>
<li>audio - Сообщения в которых содержится аудио файл</li>
<li>document - Сообщения с отправленным документом</li>
<li>photo - Сообщения с отправленными изображениями</li>
<li>sticker - Сообщения с отправленным стикером</li>
<li>video - Сообщения с видео</li>
<li>voice - Голосовые сообщения</li>
<li>contact - Сообщения в которых содержится контант телеграм пользователя</li>
<li>location - Сообщения с геолокацией</li>
<li>venue - Пересылаемые сообщения</li>
<li>game - Игры</li>
</ul>
<p>Если вы хотите совместить некоторые фильтры в одном обработчике просто используйте знак <code>|</code> - в качестве логического <strong>ИЛИ</strong>, и знак <code>&amp;</code> в качестве логического <strong>И</strong>. Например, если вы хотите что бы бот вызывал один и тот же метод когда он получает видео, изображение или документ используйте следующий пример создания обработчика сообщений:</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb26-1"><a href="-updater-2.html#cb26-1" aria-hidden="true"></a>handler &lt;-<span class="st"> </span><span class="kw">MessageHandler</span>(callback,</span>
<span id="cb26-2"><a href="-updater-2.html#cb26-2" aria-hidden="true"></a>  MessageFilters<span class="op">$</span>video <span class="op">|</span><span class="st"> </span>MessageFilters<span class="op">$</span>photo <span class="op">|</span><span class="st"> </span>MessageFilters<span class="op">$</span>document</span>
<span id="cb26-3"><a href="-updater-2.html#cb26-3" aria-hidden="true"></a>)</span></code></pre></div>
</div>
<div id="добавление-команд-с-параметрами" class="section level2" number="2.5">
<h2><span class="header-section-number">2.5</span> Добавление команд с параметрами</h2>
<p>Мы уже знаем, что такое команды, как их создавать и как заставить бота выполнить нужную команду. Но в некоторых случаях помимо названия команды, нам необходимо передать некоторые данные для её выполнения.</p>
<p>Ниже пример бота, который по заданной дате и стране возвращает вам тип дня из производственного календаря.</p>
<p>Приведённый ниже бот использует API производственного календаря <a href="https://isdayoff.ru/">isdayoff.ru</a>.</p>
<p><spoiler title="Код 3: Бот, который сообщает по дате и стране "></p>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb27-1"><a href="-updater-2.html#cb27-1" aria-hidden="true"></a><span class="kw">library</span>(telegram.bot)</span>
<span id="cb27-2"><a href="-updater-2.html#cb27-2" aria-hidden="true"></a></span>
<span id="cb27-3"><a href="-updater-2.html#cb27-3" aria-hidden="true"></a><span class="co"># создаём экземпляр класса Updater</span></span>
<span id="cb27-4"><a href="-updater-2.html#cb27-4" aria-hidden="true"></a>updater &lt;-<span class="st"> </span><span class="kw">Updater</span>(<span class="st">&#39;ТОКЕН ВАШЕГО БОТА&#39;</span>)</span>
<span id="cb27-5"><a href="-updater-2.html#cb27-5" aria-hidden="true"></a></span>
<span id="cb27-6"><a href="-updater-2.html#cb27-6" aria-hidden="true"></a><span class="co"># Пишем метод для приветсвия</span></span>
<span id="cb27-7"><a href="-updater-2.html#cb27-7" aria-hidden="true"></a><span class="co">## команда приветвия</span></span>
<span id="cb27-8"><a href="-updater-2.html#cb27-8" aria-hidden="true"></a>check_date &lt;-<span class="st"> </span><span class="cf">function</span>(bot, update, args) {</span>
<span id="cb27-9"><a href="-updater-2.html#cb27-9" aria-hidden="true"></a></span>
<span id="cb27-10"><a href="-updater-2.html#cb27-10" aria-hidden="true"></a>  <span class="co"># входящие данные</span></span>
<span id="cb27-11"><a href="-updater-2.html#cb27-11" aria-hidden="true"></a>  day     &lt;-<span class="st"> </span>args[<span class="dv">1</span>]  <span class="co"># дата</span></span>
<span id="cb27-12"><a href="-updater-2.html#cb27-12" aria-hidden="true"></a>  country &lt;-<span class="st"> </span>args[<span class="dv">2</span>]  <span class="co"># страна</span></span>
<span id="cb27-13"><a href="-updater-2.html#cb27-13" aria-hidden="true"></a></span>
<span id="cb27-14"><a href="-updater-2.html#cb27-14" aria-hidden="true"></a>  <span class="co"># проверка введённых параметров</span></span>
<span id="cb27-15"><a href="-updater-2.html#cb27-15" aria-hidden="true"></a>  <span class="cf">if</span> ( <span class="op">!</span><span class="kw">grepl</span>(<span class="st">&#39;</span><span class="ch">\\</span><span class="st">d{4}-</span><span class="ch">\\</span><span class="st">d{2}-</span><span class="ch">\\</span><span class="st">d{2}&#39;</span>, day) ) {</span>
<span id="cb27-16"><a href="-updater-2.html#cb27-16" aria-hidden="true"></a></span>
<span id="cb27-17"><a href="-updater-2.html#cb27-17" aria-hidden="true"></a>    <span class="co"># Send Custom Keyboard</span></span>
<span id="cb27-18"><a href="-updater-2.html#cb27-18" aria-hidden="true"></a>    bot<span class="op">$</span><span class="kw">sendMessage</span>(update<span class="op">$</span>message<span class="op">$</span>chat_id,</span>
<span id="cb27-19"><a href="-updater-2.html#cb27-19" aria-hidden="true"></a>                    <span class="dt">text =</span> <span class="kw">paste0</span>(day, <span class="st">&quot; - некорреткная дата, введите дату в формате ГГГГ-ММ-ДД&quot;</span>),</span>
<span id="cb27-20"><a href="-updater-2.html#cb27-20" aria-hidden="true"></a>                    <span class="dt">parse_mode =</span> <span class="st">&quot;Markdown&quot;</span>)</span>
<span id="cb27-21"><a href="-updater-2.html#cb27-21" aria-hidden="true"></a></span>
<span id="cb27-22"><a href="-updater-2.html#cb27-22" aria-hidden="true"></a>  } <span class="cf">else</span> {</span>
<span id="cb27-23"><a href="-updater-2.html#cb27-23" aria-hidden="true"></a>    day &lt;-<span class="st"> </span><span class="kw">as.Date</span>(day)</span>
<span id="cb27-24"><a href="-updater-2.html#cb27-24" aria-hidden="true"></a>    <span class="co"># переводим в формат POSIXtl</span></span>
<span id="cb27-25"><a href="-updater-2.html#cb27-25" aria-hidden="true"></a>    y &lt;-<span class="st"> </span><span class="kw">format</span>(day, <span class="st">&quot;%Y&quot;</span>)</span>
<span id="cb27-26"><a href="-updater-2.html#cb27-26" aria-hidden="true"></a>    m &lt;-<span class="st"> </span><span class="kw">format</span>(day, <span class="st">&quot;%m&quot;</span>)</span>
<span id="cb27-27"><a href="-updater-2.html#cb27-27" aria-hidden="true"></a>    d &lt;-<span class="st"> </span><span class="kw">format</span>(day, <span class="st">&quot;%d&quot;</span>)</span>
<span id="cb27-28"><a href="-updater-2.html#cb27-28" aria-hidden="true"></a></span>
<span id="cb27-29"><a href="-updater-2.html#cb27-29" aria-hidden="true"></a>  }</span>
<span id="cb27-30"><a href="-updater-2.html#cb27-30" aria-hidden="true"></a></span>
<span id="cb27-31"><a href="-updater-2.html#cb27-31" aria-hidden="true"></a>  <span class="co"># страна для проверки</span></span>
<span id="cb27-32"><a href="-updater-2.html#cb27-32" aria-hidden="true"></a>  <span class="co">## проверяем задана ли страна</span></span>
<span id="cb27-33"><a href="-updater-2.html#cb27-33" aria-hidden="true"></a>  <span class="co">## если не задана устанавливаем ru</span></span>
<span id="cb27-34"><a href="-updater-2.html#cb27-34" aria-hidden="true"></a>  <span class="cf">if</span> ( <span class="op">!</span><span class="st"> </span>country <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="st">&#39;ru&#39;</span>, <span class="st">&#39;ua&#39;</span>, <span class="st">&#39;by&#39;</span>, <span class="st">&#39;kz&#39;</span>, <span class="st">&#39;us&#39;</span>) ) {</span>
<span id="cb27-35"><a href="-updater-2.html#cb27-35" aria-hidden="true"></a></span>
<span id="cb27-36"><a href="-updater-2.html#cb27-36" aria-hidden="true"></a>    <span class="co"># Send Custom Keyboard</span></span>
<span id="cb27-37"><a href="-updater-2.html#cb27-37" aria-hidden="true"></a>    bot<span class="op">$</span><span class="kw">sendMessage</span>(update<span class="op">$</span>message<span class="op">$</span>chat_id,</span>
<span id="cb27-38"><a href="-updater-2.html#cb27-38" aria-hidden="true"></a>                    <span class="dt">text =</span> <span class="kw">paste0</span>(country, <span class="st">&quot; - некорретктный код страны, возможнные значения: ru, by, kz, ua, us. Запрошены данные по России.&quot;</span>),</span>
<span id="cb27-39"><a href="-updater-2.html#cb27-39" aria-hidden="true"></a>                    <span class="dt">parse_mode =</span> <span class="st">&quot;Markdown&quot;</span>)</span>
<span id="cb27-40"><a href="-updater-2.html#cb27-40" aria-hidden="true"></a></span>
<span id="cb27-41"><a href="-updater-2.html#cb27-41" aria-hidden="true"></a>    country &lt;-<span class="st"> &#39;ru&#39;</span></span>
<span id="cb27-42"><a href="-updater-2.html#cb27-42" aria-hidden="true"></a></span>
<span id="cb27-43"><a href="-updater-2.html#cb27-43" aria-hidden="true"></a>  }</span>
<span id="cb27-44"><a href="-updater-2.html#cb27-44" aria-hidden="true"></a></span>
<span id="cb27-45"><a href="-updater-2.html#cb27-45" aria-hidden="true"></a>  <span class="co"># запрос данных из API</span></span>
<span id="cb27-46"><a href="-updater-2.html#cb27-46" aria-hidden="true"></a>  <span class="co"># компоновка HTTP запроса</span></span>
<span id="cb27-47"><a href="-updater-2.html#cb27-47" aria-hidden="true"></a>  url &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="st">&quot;https://isdayoff.ru/api/getdata?&quot;</span>,</span>
<span id="cb27-48"><a href="-updater-2.html#cb27-48" aria-hidden="true"></a>                <span class="st">&quot;year=&quot;</span>,  y, <span class="st">&quot;&amp;&quot;</span>,</span>
<span id="cb27-49"><a href="-updater-2.html#cb27-49" aria-hidden="true"></a>                <span class="st">&quot;month=&quot;</span>, m, <span class="st">&quot;&amp;&quot;</span>,</span>
<span id="cb27-50"><a href="-updater-2.html#cb27-50" aria-hidden="true"></a>                <span class="st">&quot;day=&quot;</span>,   d, <span class="st">&quot;&amp;&quot;</span>,</span>
<span id="cb27-51"><a href="-updater-2.html#cb27-51" aria-hidden="true"></a>                <span class="st">&quot;cc=&quot;</span>,    country, <span class="st">&quot;&amp;&quot;</span>,</span>
<span id="cb27-52"><a href="-updater-2.html#cb27-52" aria-hidden="true"></a>                <span class="st">&quot;pre=1&amp;&quot;</span>,</span>
<span id="cb27-53"><a href="-updater-2.html#cb27-53" aria-hidden="true"></a>                <span class="st">&quot;covid=1&quot;</span>)</span>
<span id="cb27-54"><a href="-updater-2.html#cb27-54" aria-hidden="true"></a></span>
<span id="cb27-55"><a href="-updater-2.html#cb27-55" aria-hidden="true"></a>  <span class="co"># получаем ответ</span></span>
<span id="cb27-56"><a href="-updater-2.html#cb27-56" aria-hidden="true"></a>  res &lt;-<span class="st"> </span><span class="kw">readLines</span>(url)</span>
<span id="cb27-57"><a href="-updater-2.html#cb27-57" aria-hidden="true"></a></span>
<span id="cb27-58"><a href="-updater-2.html#cb27-58" aria-hidden="true"></a>  <span class="co"># интрепретация ответа</span></span>
<span id="cb27-59"><a href="-updater-2.html#cb27-59" aria-hidden="true"></a>  out &lt;-<span class="st"> </span><span class="cf">switch</span>(res,</span>
<span id="cb27-60"><a href="-updater-2.html#cb27-60" aria-hidden="true"></a>                <span class="st">&quot;0&quot;</span>   =<span class="st"> &quot;Рабочий день&quot;</span>,</span>
<span id="cb27-61"><a href="-updater-2.html#cb27-61" aria-hidden="true"></a>                <span class="st">&quot;1&quot;</span>   =<span class="st"> &quot;Нерабочий день&quot;</span>,</span>
<span id="cb27-62"><a href="-updater-2.html#cb27-62" aria-hidden="true"></a>                <span class="st">&quot;2&quot;</span>   =<span class="st"> &quot;Сокращённый рабочий день&quot;</span>,</span>
<span id="cb27-63"><a href="-updater-2.html#cb27-63" aria-hidden="true"></a>                <span class="st">&quot;4&quot;</span>   =<span class="st"> &quot;covid-19&quot;</span>,</span>
<span id="cb27-64"><a href="-updater-2.html#cb27-64" aria-hidden="true"></a>                <span class="st">&quot;100&quot;</span> =<span class="st"> &quot;Ошибка в дате&quot;</span>,</span>
<span id="cb27-65"><a href="-updater-2.html#cb27-65" aria-hidden="true"></a>                <span class="st">&quot;101&quot;</span> =<span class="st"> &quot;Данные не найдены&quot;</span>,</span>
<span id="cb27-66"><a href="-updater-2.html#cb27-66" aria-hidden="true"></a>                <span class="st">&quot;199&quot;</span> =<span class="st"> &quot;Ошибка сервиса&quot;</span>)</span>
<span id="cb27-67"><a href="-updater-2.html#cb27-67" aria-hidden="true"></a></span>
<span id="cb27-68"><a href="-updater-2.html#cb27-68" aria-hidden="true"></a>  <span class="co"># отправляем сообщение</span></span>
<span id="cb27-69"><a href="-updater-2.html#cb27-69" aria-hidden="true"></a>  bot<span class="op">$</span><span class="kw">sendMessage</span>(update<span class="op">$</span>message<span class="op">$</span>chat_id,</span>
<span id="cb27-70"><a href="-updater-2.html#cb27-70" aria-hidden="true"></a>                  <span class="dt">text =</span> <span class="kw">paste0</span>(day, <span class="st">&quot; - &quot;</span>, out),</span>
<span id="cb27-71"><a href="-updater-2.html#cb27-71" aria-hidden="true"></a>                  <span class="dt">parse_mode =</span> <span class="st">&quot;Markdown&quot;</span>)</span>
<span id="cb27-72"><a href="-updater-2.html#cb27-72" aria-hidden="true"></a></span>
<span id="cb27-73"><a href="-updater-2.html#cb27-73" aria-hidden="true"></a>}</span>
<span id="cb27-74"><a href="-updater-2.html#cb27-74" aria-hidden="true"></a></span>
<span id="cb27-75"><a href="-updater-2.html#cb27-75" aria-hidden="true"></a><span class="co"># создаём обработчик</span></span>
<span id="cb27-76"><a href="-updater-2.html#cb27-76" aria-hidden="true"></a>date_hendler &lt;-<span class="st"> </span><span class="kw">CommandHandler</span>(<span class="st">&#39;check_date&#39;</span>, check_date, <span class="dt">pass_args =</span> <span class="ot">TRUE</span>)</span>
<span id="cb27-77"><a href="-updater-2.html#cb27-77" aria-hidden="true"></a></span>
<span id="cb27-78"><a href="-updater-2.html#cb27-78" aria-hidden="true"></a><span class="co"># добаляем обработчик в диспетчер</span></span>
<span id="cb27-79"><a href="-updater-2.html#cb27-79" aria-hidden="true"></a>updater &lt;-<span class="st"> </span>updater <span class="op">+</span><span class="st"> </span>date_hendler</span>
<span id="cb27-80"><a href="-updater-2.html#cb27-80" aria-hidden="true"></a></span>
<span id="cb27-81"><a href="-updater-2.html#cb27-81" aria-hidden="true"></a><span class="co"># запускаем бота</span></span>
<span id="cb27-82"><a href="-updater-2.html#cb27-82" aria-hidden="true"></a>updater<span class="op">$</span><span class="kw">start_polling</span>()</span></code></pre></div>
<p></spoiler></p>
<blockquote>
<p>Запустите приведённый выше пример кода, предварительно заменив ‘ТОКЕН ВАШЕГО БОТА’ на реальный токен, который вы получили при создании бота через <em>BotFather</em>.</p>
</blockquote>
<p>Мы создали бота, который в арсенале имеет всего один метод <code>check_date</code>, данный метод вызывается одноимённой командой.</p>
<p>Но, помимо имени команды, данный метод ждёт от вас введения двух параметров, код страны и дату. Далее бот проверяется, является ли заданный день в указанной стране выходным, сокращённым или рабочим согласно официального производственного календаря.</p>
<p>Что бы создаваемый нами метод принимал дополнительные параметры вместе с командой, используйте аргумент <code>pass_args = TRUE</code> в функции <code>CommandHandler()</code>, и при создании метода, помимо обязательных аргументов <em>bot</em>, <em>update</em> создайте опциональный - <em>args</em>. Созданный таким образом метод будет принимать параметры, которые вы передаёте боту после названия команды. Параметры необходимо между собой разделять пробелом, в метод они поступят в виде текстового вектора.</p>
<p>Давайте запустим, и протестируем нашего бота.</p>
<p><img src="http://img.netpeak.ua/alsey/159803059802_kiss_204kb.png" /></p>
</div>
<div id="запускаем-бота-в-фоновом-режиме" class="section level2" number="2.6">
<h2><span class="header-section-number">2.6</span> Запускаем бота в фоновом режиме</h2>
<p>Последний шаг который нам осталось выполнить - запустить бота в фоновом режиме.</p>
<p>Для этого следуйте по описанному ниже алгоритму:</p>
<ol style="list-style-type: decimal">
<li>Сохраните код бота в файл с расширением R. При работе в RStudio это делается через меню <em>File</em>, командой <em>Save As…</em>.</li>
<li>Добавьте путь к папке bin, которая в свою очередь находится в папке в которую вы установили язык R в переменную Path, инструкция <a href="https://www.java.com/ru/download/help/path.xml">тут</a>.</li>
<li>Создайте обычный текстовый файл, в котором пропишите 1 строку: <code>R CMD BATCH C:\Users\Alsey\Documents\my_bot.R</code>. Вместо *C:_bot.R* пропишите путь к своему скрипту бота. При этом важно, что бы в пути не встречалась кириллица и пробелы, т.к. это может вызвать проблемы при запуске бота. Сохраните его, и замените его расширение с <em>txt</em> на <em>bat</em>.</li>
<li>Откройте планировщик заданий Windows, есть множество способов это сделать, например откройте любую папку и в адресс введите <code>%windir%\system32\taskschd.msc /s</code>. Другие способы запуска можно найти <a href="https://remontka.pro/open-task-scheduler-windows/">тут</a>.</li>
<li>В верхнем правом меню планировщика нажмите “Создать задачу…”.</li>
<li>На вкладке “Общие” задайте произвольное имя вашей задаче, и переключатель перевидите в состояние “Выполнять для всех пользователей”.</li>
<li>Перейдите на вкладку “Действия”, нажмите “Создать”. В поле “Программа или сценарий” нажмите “Обзор”, найдите созданный на втором шаге <em>bat</em> файл, и нажмите ОК.</li>
<li>Жмём ОК, при необходимости вводим пароль от вашей учётной записи операционной системы.</li>
<li>Находим в планировщике созданную задачу, выделяем и в нижнем правом углу жмём кнопку “Выполнить”.</li>
</ol>
<p>Наш бот запущен в фоновом режиме, и будет работать до тех пор, пока вы не остановите задачу, или не выключите ваш ПК или сервер на котором его запустили.</p>
</div>
<div id="как-добавить-бота-в-группу" class="section level2" number="2.7">
<h2><span class="header-section-number">2.7</span> Как добавить бота в группу</h2>
<p>Для того, что бы использовать бота в публичных или закрытых группах, изначально проверьте соответвующую настройку в <a href="http://t.me/BotFather">BotFather</a>. По умолчанию эта настройка должна быть включена. Находится она тут: <code>/mybots</code> -&gt; <code>@bot_username</code> -&gt; Bot Settings -&gt; Allow Groups?. Если настройка включена то вы увидите следующее сообщение:</p>
<p><img src="http://img.netpeak.ua/alsey/160404844191_kiss_22kb.png" /></p>
<p>Далее добааляете бота в нужные группы и используете его через команды. Если вам необходимо сделать так, что бы бот прослушивал не только команды, но и все сообщения в группе, то вам необходимо назначить его администратором, посе чего вы увидите что бот имеет доступ ко всем сообщениям.</p>
<p><img src="http://img.netpeak.ua/alsey/160404861398_kiss_36kb.png" /></p>
</div>
<div id="как-добавить-описание-команд-в-интерфейс-бота" class="section level2" number="2.8">
<h2><span class="header-section-number">2.8</span> Как добавить описание команд в интерфейс бота</h2>
<p>Теперь вы умеете создавать полноценных ботов, которых помимо вас могут использовать другие пользователи. Но, для того, что бы облегчить поиск нужных команд вы можете добавить их в интефейс бота.</p>
<p>Выглядеть это будет вот так:
<img src="http://img.netpeak.ua/alsey/160400158803_kiss_127kb.png" /></p>
<p>Делается это через <a href="@@BotFather">BotFather</a> -&gt; <code>@bot_username</code> -&gt; Edit Bot -&gt; Edit Commands. Далее просто передаёте название команды и через тире их описание:</p>
<pre><code>command1 - Description
command2 - Another description</code></pre>
</div>
<div id="заключение-1" class="section level2" number="2.9">
<h2><span class="header-section-number">2.9</span> Заключение</h2>
<p>В этой главе мы разобрались как написать полноценного бота, который не только умеет отправлять сообщения, но и реагировать на входящие сообщения и команды. Полученных знананий уже достаточно для решения большинства ваших задач.</p>
<p>В следующей главе речь пойдёт о том, как добавить боту клавиатуру, для более удобной работы.</p>
<p>Подписываетесь на мой <a href="https://t.me/R4marketing">telegram</a> и <a href="https://www.youtube.com/R4marketing/?sub_confirmation=1">youtube</a> каналы.</p>
</div>
<div id="тесты-и-задания-1" class="section level2" number="2.10">
<h2><span class="header-section-number">2.10</span> Тесты и задания</h2>
<div id="тесты-1" class="section level3" number="2.10.1">
<h3><span class="header-section-number">2.10.1</span> Тесты</h3>
<p>Для закрепления материла рекомендую вам пройти тест доступный по <a href="https://onlinetestpad.com/t/build-tg-bot-in-r-2">ссылке</a>.</p>
</div>
<div id="задания-1" class="section level3" number="2.10.2">
<h3><span class="header-section-number">2.10.2</span> Задания</h3>
<ol style="list-style-type: decimal">
<li>Создайте бота, который будет по команде <code>/sum</code> и переданное в качестве дополнительных параметров произвольное количество перечисленных через пробел чисел, возвращать их сумму.</li>
</ol>
<p>Если вы всё сделали правильно результат должен быть таким:
<img src="http://img.netpeak.ua/alsey/160400138798_kiss_126kb.png" /></p>

</div>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="-telegram-1.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="-3.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/rstudio/bookdown-demo/edit/master/02-commands.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["bookdown-demo.pdf", "bookdown-demo.epub"],
"toc": {
"collapse": "subsection"
}
});
});
</script>

</body>

</html>

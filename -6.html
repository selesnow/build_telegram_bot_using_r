<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Глава 6 Повышаем стабильность работы бота  | Разработка telegram ботов на языке R</title>
  <meta name="description" content="This is a minimal example of using the bookdown package to write a book. The output format for this example is bookdown::gitbook." />
  <meta name="generator" content="bookdown 0.21 and GitBook 2.6.7" />

  <meta property="og:title" content="Глава 6 Повышаем стабильность работы бота  | Разработка telegram ботов на языке R" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="This is a minimal example of using the bookdown package to write a book. The output format for this example is bookdown::gitbook." />
  <meta name="github-repo" content="rstudio/bookdown-demo" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Глава 6 Повышаем стабильность работы бота  | Разработка telegram ботов на языке R" />
  
  <meta name="twitter:description" content="This is a minimal example of using the bookdown package to write a book. The output format for this example is bookdown::gitbook." />
  

<meta name="author" content="Алексей Селезнёв" />


<meta name="date" content="2020-11-13" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="-5.html"/>
<link rel="next" href="-tasks.html"/>
<script src="libs/header-attrs-2.4/header-attrs.js"></script>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />











<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Разработка Telegram ботов на языке R</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Введение</a>
<ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#предисловие"><i class="fa fa-check"></i>Предисловие</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#навыки-необходимые-для-прохождения-учебника"><i class="fa fa-check"></i>Навыки необходимые для прохождения учебника</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#об-авторе"><i class="fa fa-check"></i>Об авторе</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#правки-и-предложения"><i class="fa fa-check"></i>Правки и предложения</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#поддержать-проект"><i class="fa fa-check"></i>Поддержать проект</a></li>
</ul></li>
<li class="chapter" data-level="1" data-path="-telegram-1.html"><a href="-telegram-1.html"><i class="fa fa-check"></i><b>1</b> Создаём бота, и отправляем с его помощью сообщения в telegram </a>
<ul>
<li class="chapter" data-level="1.1" data-path="-telegram-1.html"><a href="-telegram-1.html#создание-телеграм-бота"><i class="fa fa-check"></i><b>1.1</b> Создание телеграм бота</a></li>
<li class="chapter" data-level="1.2" data-path="-telegram-1.html"><a href="-telegram-1.html#установка-пакета-для-работы-с-телеграм-ботом-на-r"><i class="fa fa-check"></i><b>1.2</b> Установка пакета для работы с телеграм ботом на R</a></li>
<li class="chapter" data-level="1.3" data-path="-telegram-1.html"><a href="-telegram-1.html#отправка-сообщений-из-r-в-telegram"><i class="fa fa-check"></i><b>1.3</b> Отправка сообщений из R в Telegram</a></li>
<li class="chapter" data-level="1.4" data-path="-telegram-1.html"><a href="-telegram-1.html#как-отправить-в-telegram-таблицу"><i class="fa fa-check"></i><b>1.4</b> Как отправить в telegram таблицу</a></li>
<li class="chapter" data-level="1.5" data-path="-telegram-1.html"><a href="-telegram-1.html#как-добавить-в-сообщение-emoji"><i class="fa fa-check"></i><b>1.5</b> Как добавить в сообщение Emoji</a></li>
<li class="chapter" data-level="1.6" data-path="-telegram-1.html"><a href="-telegram-1.html#проверка-планировщика-задач-windows-и-отправка-уведомления-о-задачах-работа-которых-была-завершена-аварийно"><i class="fa fa-check"></i><b>1.6</b> Проверка планировщика задач Windows, и отправка уведомления о задачах, работа которых была завершена аварийно</a></li>
<li class="chapter" data-level="1.7" data-path="-telegram-1.html"><a href="-telegram-1.html#настраиваем-расписание-запуска-проверки-задач"><i class="fa fa-check"></i><b>1.7</b> Настраиваем расписание запуска проверки задач</a></li>
<li class="chapter" data-level="1.8" data-path="-telegram-1.html"><a href="-telegram-1.html#заключение"><i class="fa fa-check"></i><b>1.8</b> Заключение</a></li>
<li class="chapter" data-level="1.9" data-path="-telegram-1.html"><a href="-telegram-1.html#тесты-и-задания"><i class="fa fa-check"></i><b>1.9</b> Тесты и задания</a>
<ul>
<li class="chapter" data-level="1.9.1" data-path="-telegram-1.html"><a href="-telegram-1.html#тесты"><i class="fa fa-check"></i><b>1.9.1</b> Тесты</a></li>
<li class="chapter" data-level="1.9.2" data-path="-telegram-1.html"><a href="-telegram-1.html#задания"><i class="fa fa-check"></i><b>1.9.2</b> Задания</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="2" data-path="-updater-2.html"><a href="-updater-2.html"><i class="fa fa-check"></i><b>2</b> Добавляем боту поддержку команд и фильтры сообщений, класс Updater </a>
<ul>
<li class="chapter" data-level="2.1" data-path="-updater-2.html"><a href="-updater-2.html#класс-updater"><i class="fa fa-check"></i><b>2.1</b> Класс Updater</a></li>
<li class="chapter" data-level="2.2" data-path="-updater-2.html"><a href="-updater-2.html#handlers---обработчики"><i class="fa fa-check"></i><b>2.2</b> Handlers - обработчики</a></li>
<li class="chapter" data-level="2.3" data-path="-updater-2.html"><a href="-updater-2.html#добавляем-первую-команду-боту-обработчик-команд"><i class="fa fa-check"></i><b>2.3</b> Добавляем первую команду боту, обработчик команд</a></li>
<li class="chapter" data-level="2.4" data-path="-updater-2.html"><a href="-updater-2.html#обработчик-текстовых-сообщений-и-фильтры"><i class="fa fa-check"></i><b>2.4</b> Обработчик текстовых сообщений и фильтры</a></li>
<li class="chapter" data-level="2.5" data-path="-updater-2.html"><a href="-updater-2.html#добавление-команд-с-параметрами"><i class="fa fa-check"></i><b>2.5</b> Добавление команд с параметрами</a></li>
<li class="chapter" data-level="2.6" data-path="-updater-2.html"><a href="-updater-2.html#запускаем-бота-в-фоновом-режиме"><i class="fa fa-check"></i><b>2.6</b> Запускаем бота в фоновом режиме</a></li>
<li class="chapter" data-level="2.7" data-path="-updater-2.html"><a href="-updater-2.html#как-добавить-бота-в-группу"><i class="fa fa-check"></i><b>2.7</b> Как добавить бота в группу</a></li>
<li class="chapter" data-level="2.8" data-path="-updater-2.html"><a href="-updater-2.html#как-добавить-описание-команд-в-интерфейс-бота"><i class="fa fa-check"></i><b>2.8</b> Как добавить описание команд в интерфейс бота</a></li>
<li class="chapter" data-level="2.9" data-path="-updater-2.html"><a href="-updater-2.html#заключение-1"><i class="fa fa-check"></i><b>2.9</b> Заключение</a></li>
<li class="chapter" data-level="2.10" data-path="-updater-2.html"><a href="-updater-2.html#тесты-и-задания-1"><i class="fa fa-check"></i><b>2.10</b> Тесты и задания</a>
<ul>
<li class="chapter" data-level="2.10.1" data-path="-updater-2.html"><a href="-updater-2.html#тесты-1"><i class="fa fa-check"></i><b>2.10.1</b> Тесты</a></li>
<li class="chapter" data-level="2.10.2" data-path="-updater-2.html"><a href="-updater-2.html#задания-1"><i class="fa fa-check"></i><b>2.10.2</b> Задания</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="3" data-path="-3.html"><a href="-3.html"><i class="fa fa-check"></i><b>3</b> Как добавить боту поддержку клавиатуры </a>
<ul>
<li class="chapter" data-level="3.1" data-path="-3.html"><a href="-3.html#какие-типы-клавиатур-поддерживает-телеграм-бот"><i class="fa fa-check"></i><b>3.1</b> Какие типы клавиатур поддерживает телеграм бот</a></li>
<li class="chapter" data-level="3.2" data-path="-3.html"><a href="-3.html#reply-клавиатура"><i class="fa fa-check"></i><b>3.2</b> Reply клавиатура</a></li>
<li class="chapter" data-level="3.3" data-path="-3.html"><a href="-3.html#inline-клавиатура"><i class="fa fa-check"></i><b>3.3</b> Inline клавиатура</a>
<ul>
<li class="chapter" data-level="3.3.1" data-path="-3.html"><a href="-3.html#пример-простейшего-бота-с-поддержкой-inline-кнопок"><i class="fa fa-check"></i><b>3.3.1</b> Пример простейшего бота с поддержкой InLine кнопок</a></li>
<li class="chapter" data-level="3.3.2" data-path="-3.html"><a href="-3.html#пример-бота-который-сообщает-текущую-погоду-по-выбранному-городу"><i class="fa fa-check"></i><b>3.3.2</b> Пример бота, который сообщает текущую погоду по выбранному городу</a></li>
<li class="chapter" data-level="3.3.3" data-path="-3.html"><a href="-3.html#пример-бота-который-выводит-список-самых-свежих-статей-со-ссылками-по-указанному-хабу-из-habr.com."><i class="fa fa-check"></i><b>3.3.3</b> Пример бота, который выводит список самых свежих статей со ссылками по-указанному Хабу из <span>habr.com</span>.</a></li>
</ul></li>
<li class="chapter" data-level="3.4" data-path="-3.html"><a href="-3.html#заключение-2"><i class="fa fa-check"></i><b>3.4</b> Заключение</a></li>
<li class="chapter" data-level="3.5" data-path="-3.html"><a href="-3.html#тесты-и-задания-2"><i class="fa fa-check"></i><b>3.5</b> Тесты и задания</a>
<ul>
<li class="chapter" data-level="3.5.1" data-path="-3.html"><a href="-3.html#тесты-2"><i class="fa fa-check"></i><b>3.5.1</b> Тесты</a></li>
<li class="chapter" data-level="3.5.2" data-path="-3.html"><a href="-3.html#задания-2"><i class="fa fa-check"></i><b>3.5.2</b> Задания</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="4" data-path="-4.html"><a href="-4.html"><i class="fa fa-check"></i><b>4</b> Построение последовательного, логического диалога с ботом </a>
<ul>
<li class="chapter" data-level="4.1" data-path="-4.html"><a href="-4.html#введение-1"><i class="fa fa-check"></i><b>4.1</b> Введение</a></li>
<li class="chapter" data-level="4.2" data-path="-4.html"><a href="-4.html#процесс-построения-бота"><i class="fa fa-check"></i><b>4.2</b> Процесс построения бота</a></li>
<li class="chapter" data-level="4.3" data-path="-4.html"><a href="-4.html#структура-проекта-бота"><i class="fa fa-check"></i><b>4.3</b> Структура проекта бота</a></li>
<li class="chapter" data-level="4.4" data-path="-4.html"><a href="-4.html#конфиг-бота"><i class="fa fa-check"></i><b>4.4</b> Конфиг бота</a></li>
<li class="chapter" data-level="4.5" data-path="-4.html"><a href="-4.html#создаём-переменную-среды"><i class="fa fa-check"></i><b>4.5</b> Создаём переменную среды</a></li>
<li class="chapter" data-level="4.6" data-path="-4.html"><a href="-4.html#создаём-базу-данных"><i class="fa fa-check"></i><b>4.6</b> Создаём базу данных</a></li>
<li class="chapter" data-level="4.7" data-path="-4.html"><a href="-4.html#пишем-функции-для-работы-с-базой-данных"><i class="fa fa-check"></i><b>4.7</b> Пишем функции для работы с базой данных</a></li>
<li class="chapter" data-level="4.8" data-path="-4.html"><a href="-4.html#методы-бота"><i class="fa fa-check"></i><b>4.8</b> Методы бота</a></li>
<li class="chapter" data-level="4.9" data-path="-4.html"><a href="-4.html#фильтры-сообщений"><i class="fa fa-check"></i><b>4.9</b> Фильтры сообщений</a></li>
<li class="chapter" data-level="4.10" data-path="-4.html"><a href="-4.html#обработчики"><i class="fa fa-check"></i><b>4.10</b> Обработчики</a></li>
<li class="chapter" data-level="4.11" data-path="-4.html"><a href="-4.html#код-запуска-бота"><i class="fa fa-check"></i><b>4.11</b> Код запуска бота</a></li>
<li class="chapter" data-level="4.12" data-path="-4.html"><a href="-4.html#заключение-3"><i class="fa fa-check"></i><b>4.12</b> Заключение</a></li>
<li class="chapter" data-level="4.13" data-path="-4.html"><a href="-4.html#тесты-и-задания-3"><i class="fa fa-check"></i><b>4.13</b> Тесты и задания</a>
<ul>
<li class="chapter" data-level="4.13.1" data-path="-4.html"><a href="-4.html#тесты-3"><i class="fa fa-check"></i><b>4.13.1</b> Тесты</a></li>
<li class="chapter" data-level="4.13.2" data-path="-4.html"><a href="-4.html#задания-3"><i class="fa fa-check"></i><b>4.13.2</b> Задания</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="5" data-path="-5.html"><a href="-5.html"><i class="fa fa-check"></i><b>5</b> Управление правами пользователей бота </a>
<ul>
<li class="chapter" data-level="5.1" data-path="-5.html"><a href="-5.html#введение-2"><i class="fa fa-check"></i><b>5.1</b> Введение</a></li>
<li class="chapter" data-level="5.2" data-path="-5.html"><a href="-5.html#ограничиваем-права-пользователя-с-помощью-фильтров-сообщений"><i class="fa fa-check"></i><b>5.2</b> Ограничиваем права пользователя с помощью фильтров сообщений</a>
<ul>
<li class="chapter" data-level="5.2.1" data-path="-5.html"><a href="-5.html#ограничиваем-права-на-уровне-имени-пользователя"><i class="fa fa-check"></i><b>5.2.1</b> Ограничиваем права на уровне имени пользователя</a></li>
<li class="chapter" data-level="5.2.2" data-path="-5.html"><a href="-5.html#ограничиваем-права-на-уровне-чата"><i class="fa fa-check"></i><b>5.2.2</b> Ограничиваем права на уровне чата</a></li>
</ul></li>
<li class="chapter" data-level="5.3" data-path="-5.html"><a href="-5.html#ограничиваем-права-пользователя-внутри-кода-методов"><i class="fa fa-check"></i><b>5.3</b> Ограничиваем права пользователя внутри кода методов</a>
<ul>
<li class="chapter" data-level="5.3.1" data-path="-5.html"><a href="-5.html#ограничиваем-права-на-уровне-имени-пользователя-1"><i class="fa fa-check"></i><b>5.3.1</b> Ограничиваем права на уровне имени пользователя</a></li>
<li class="chapter" data-level="5.3.2" data-path="-5.html"><a href="-5.html#ограничиваем-права-на-уровне-чата-1"><i class="fa fa-check"></i><b>5.3.2</b> Ограничиваем права на уровне чата</a></li>
</ul></li>
<li class="chapter" data-level="5.4" data-path="-5.html"><a href="-5.html#заключение-4"><i class="fa fa-check"></i><b>5.4</b> Заключение</a></li>
<li class="chapter" data-level="5.5" data-path="-5.html"><a href="-5.html#тесты-и-задания-4"><i class="fa fa-check"></i><b>5.5</b> Тесты и задания</a>
<ul>
<li class="chapter" data-level="5.5.1" data-path="-5.html"><a href="-5.html#тесты-4"><i class="fa fa-check"></i><b>5.5.1</b> Тесты</a></li>
<li class="chapter" data-level="5.5.2" data-path="-5.html"><a href="-5.html#задания-4"><i class="fa fa-check"></i><b>5.5.2</b> Задания</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="6" data-path="-6.html"><a href="-6.html"><i class="fa fa-check"></i><b>6</b> Повышаем стабильность работы бота </a>
<ul>
<li class="chapter" data-level="6.1" data-path="-6.html"><a href="-6.html#конструкция-trycatch"><i class="fa fa-check"></i><b>6.1</b> Конструкция tryCatch()</a></li>
<li class="chapter" data-level="6.2" data-path="-6.html"><a href="-6.html#логика-работы-конструкции-trycatch"><i class="fa fa-check"></i><b>6.2</b> Логика работы конструкции tryCatch()</a></li>
<li class="chapter" data-level="6.3" data-path="-6.html"><a href="-6.html#используем-trycatch-внутри-бота"><i class="fa fa-check"></i><b>6.3</b> Используем tryCatch() внутри бота</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="-tasks.html"><a href="-tasks.html"><i class="fa fa-check"></i>Решение задач</a>
<ul>
<li class="chapter" data-level="" data-path="-tasks.html"><a href="-tasks.html#задача-1.1"><i class="fa fa-check"></i>Задача 1.1</a></li>
<li class="chapter" data-level="" data-path="-tasks.html"><a href="-tasks.html#задача-2.1"><i class="fa fa-check"></i>Задача 2.1</a></li>
<li class="chapter" data-level="" data-path="-tasks.html"><a href="-tasks.html#задача-3.1"><i class="fa fa-check"></i>Задача 3.1</a></li>
<li class="chapter" data-level="" data-path="-tasks.html"><a href="-tasks.html#задача-4.1"><i class="fa fa-check"></i>Задача 4.1</a></li>
<li class="chapter" data-level="" data-path="-tasks.html"><a href="-tasks.html#задача-5.1"><i class="fa fa-check"></i>Задача 5.1</a></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://t.me/R4marketing" target="blank">Канал R4marketing</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Разработка telegram ботов на языке R</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="повышаем-стабильность-работы-бота-6" class="section level1" number="6">
<h1><span class="header-section-number">Глава 6</span> Повышаем стабильность работы бота </h1>
<p>К этому моменту вы знаете уже достаточно для того, что бы решить значительную часть своих задач по ботостроению. Простой бот будет работать достаточно стабильно, но всё равно иногда сервера API Telegram могут давать сбои, и даже если в вашем коде нет ошибок, и пользователи используют его правильно, иногда он может падать.</p>
<p>В этой главе мы поговорим о том, как повысить работоспособность бота за счёт отлавливания и обработки ошибок пуллинга.</p>
<div id="конструкция-trycatch" class="section level2" number="6.1">
<h2><span class="header-section-number">6.1</span> Конструкция tryCatch()</h2>
<p>Помочь повысить работоспособность вашего бота поможет конструкция <code>tryCatch()</code>. Данная конструкция имеет следующий синтаксис:</p>
<div class="sourceCode" id="cb66"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb66-1"><a href="-6.html#cb66-1" aria-hidden="true"></a><span class="kw">tryCatch</span>(<span class="dt">expr =</span> {</span>
<span id="cb66-2"><a href="-6.html#cb66-2" aria-hidden="true"></a>  </span>
<span id="cb66-3"><a href="-6.html#cb66-3" aria-hidden="true"></a>    <span class="op">~</span><span class="st"> </span>Тут код который будет выполняться <span class="op">~</span></span>
<span id="cb66-4"><a href="-6.html#cb66-4" aria-hidden="true"></a><span class="st">  </span></span>
<span id="cb66-5"><a href="-6.html#cb66-5" aria-hidden="true"></a>}, </span>
<span id="cb66-6"><a href="-6.html#cb66-6" aria-hidden="true"></a>  <span class="dt">error =</span> <span class="cf">function</span>(err) {</span>
<span id="cb66-7"><a href="-6.html#cb66-7" aria-hidden="true"></a>    </span>
<span id="cb66-8"><a href="-6.html#cb66-8" aria-hidden="true"></a>    <span class="op">~</span><span class="st"> </span>код который будет выполняться в случае возникновения ошибки в блоке expr <span class="op">~</span></span>
<span id="cb66-9"><a href="-6.html#cb66-9" aria-hidden="true"></a><span class="st">    </span></span>
<span id="cb66-10"><a href="-6.html#cb66-10" aria-hidden="true"></a><span class="st">  </span>}, </span>
<span id="cb66-11"><a href="-6.html#cb66-11" aria-hidden="true"></a>  <span class="dt">finally =</span> {</span>
<span id="cb66-12"><a href="-6.html#cb66-12" aria-hidden="true"></a>    </span>
<span id="cb66-13"><a href="-6.html#cb66-13" aria-hidden="true"></a>    <span class="op">~</span><span class="st"> </span>Код который будет выполняться в любом случае, не зависимо от того закончилось выражение expr ошибкой или нет <span class="op">~</span></span>
<span id="cb66-14"><a href="-6.html#cb66-14" aria-hidden="true"></a><span class="st">    </span></span>
<span id="cb66-15"><a href="-6.html#cb66-15" aria-hidden="true"></a><span class="st">  </span>})</span></code></pre></div>
</div>
<div id="логика-работы-конструкции-trycatch" class="section level2" number="6.2">
<h2><span class="header-section-number">6.2</span> Логика работы конструкции tryCatch()</h2>
<p>Из описанного синтаксиса понятно, что вам необходимо завернуть выражение в фигурные скобки в аргументе <code>expr</code>. Это выражение будет выполняться либо до тех пор, пока не встретится ошибка, либо если ошибки нет, оно будет выполнено полностью.</p>
<p>Если в выражении переданном в <code>expr</code> встречается ошибка, то конструкция <code>tryCath()</code> запустит анонимную функцию, которую вы передали в блоке <code>error</code>.</p>
<p>В любом случае не зависимо от того встретилась в выражении <code>expr</code> ошибка или нет, в завершении выполнения будет выполнен код, переданный в аргумент <code>finnaly</code>.</p>
<p>Если вы хотите более подробно узнать про конструкцию <code>tryCatch()</code> посмотрите этот <a href="https://youtu.be/GvmjW34IHu8">видео урок</a>.</p>
</div>
<div id="используем-trycatch-внутри-бота" class="section level2" number="6.3">
<h2><span class="header-section-number">6.3</span> Используем tryCatch() внутри бота</h2>
<p>По большому счёту вы можете использовать <code>tryCatch()</code> внутри каждой функции вашего бота. Но можно убить всех зайцев одним выстрелом.</p>
<p>В разработке ботов слабым местом является пуллинг, т.е. метод <code>updater$start_polling()</code>, именно он выполняется всё время работы бота, и даёт сбои если пользователь неправильно использовал бота, или API Telegram дал сбой. Соответственно если завернуть пуллинг в <code>tryCatch()</code>, и перезапускать вашего бота в бота в блоке <code>finally</code> то при любой ошибке он будет самостоятельно перезапускаться.</p>
<p>Перед перезапуском бота не забывайте очистить его апдейты, что бы избавиться от ошибки, которая вызвала падение бота.</p>
<p>Выглядеть такой пуллинг будет следующим образом:</p>
<div class="sourceCode" id="cb67"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb67-1"><a href="-6.html#cb67-1" aria-hidden="true"></a><span class="kw">tryCatch</span>(</span>
<span id="cb67-2"><a href="-6.html#cb67-2" aria-hidden="true"></a>  </span>
<span id="cb67-3"><a href="-6.html#cb67-3" aria-hidden="true"></a>  <span class="co"># запускаем пуллинг</span></span>
<span id="cb67-4"><a href="-6.html#cb67-4" aria-hidden="true"></a>  <span class="dt">expr =</span> updater<span class="op">$</span><span class="kw">start_polling</span>(), </span>
<span id="cb67-5"><a href="-6.html#cb67-5" aria-hidden="true"></a>  </span>
<span id="cb67-6"><a href="-6.html#cb67-6" aria-hidden="true"></a>  <span class="co"># действия при ошибке пуллинга</span></span>
<span id="cb67-7"><a href="-6.html#cb67-7" aria-hidden="true"></a>  <span class="dt">error =</span> <span class="cf">function</span>(err) {</span>
<span id="cb67-8"><a href="-6.html#cb67-8" aria-hidden="true"></a>    </span>
<span id="cb67-9"><a href="-6.html#cb67-9" aria-hidden="true"></a>    <span class="co"># время падения бота</span></span>
<span id="cb67-10"><a href="-6.html#cb67-10" aria-hidden="true"></a>    bot_crash_time &lt;-<span class="st"> </span><span class="kw">Sys.time</span>()</span>
<span id="cb67-11"><a href="-6.html#cb67-11" aria-hidden="true"></a>    bot_work_time  &lt;-<span class="st"> </span><span class="kw">difftime</span>(bot_crash_time, bot_start_time,<span class="dt">units =</span>  <span class="st">&#39;hours&#39;</span>)</span>
<span id="cb67-12"><a href="-6.html#cb67-12" aria-hidden="true"></a>    </span>
<span id="cb67-13"><a href="-6.html#cb67-13" aria-hidden="true"></a>    <span class="co"># бот для оповещения</span></span>
<span id="cb67-14"><a href="-6.html#cb67-14" aria-hidden="true"></a>    bot &lt;-<span class="st"> </span><span class="kw">Bot</span>(<span class="dt">token =</span> <span class="kw">bot_token</span>(<span class="st">&quot;Токен вашего бота&quot;</span>))</span>
<span id="cb67-15"><a href="-6.html#cb67-15" aria-hidden="true"></a>    </span>
<span id="cb67-16"><a href="-6.html#cb67-16" aria-hidden="true"></a>    <span class="co"># чат для оповещения</span></span>
<span id="cb67-17"><a href="-6.html#cb67-17" aria-hidden="true"></a>    chat_id &lt;-<span class="st"> &quot;Идентификатор чата в который необходимо отправить сообщение&quot;</span></span>
<span id="cb67-18"><a href="-6.html#cb67-18" aria-hidden="true"></a>    </span>
<span id="cb67-19"><a href="-6.html#cb67-19" aria-hidden="true"></a>    <span class="co"># сообщение</span></span>
<span id="cb67-20"><a href="-6.html#cb67-20" aria-hidden="true"></a>    msg &lt;-<span class="st"> </span><span class="kw">str_glue</span>(<span class="st">&quot;*Бот упал*: Ошибка (_{err$message}_).&quot;</span>)</span>
<span id="cb67-21"><a href="-6.html#cb67-21" aria-hidden="true"></a>    </span>
<span id="cb67-22"><a href="-6.html#cb67-22" aria-hidden="true"></a>    bot<span class="op">$</span><span class="kw">sendMessage</span>(<span class="dt">chat_id =</span> chat_id, </span>
<span id="cb67-23"><a href="-6.html#cb67-23" aria-hidden="true"></a>                    <span class="dt">text =</span> msg,</span>
<span id="cb67-24"><a href="-6.html#cb67-24" aria-hidden="true"></a>                    <span class="dt">parse_mode =</span> <span class="st">&#39;Markdown&#39;</span>)</span>
<span id="cb67-25"><a href="-6.html#cb67-25" aria-hidden="true"></a>    </span>
<span id="cb67-26"><a href="-6.html#cb67-26" aria-hidden="true"></a>    <span class="co"># очищаем всё чтов бота прилетело</span></span>
<span id="cb67-27"><a href="-6.html#cb67-27" aria-hidden="true"></a>    updater<span class="op">$</span>bot<span class="op">$</span><span class="kw">clean_updates</span>()</span>
<span id="cb67-28"><a href="-6.html#cb67-28" aria-hidden="true"></a>    </span>
<span id="cb67-29"><a href="-6.html#cb67-29" aria-hidden="true"></a>    <span class="co"># информация о том, что бот будет перезапущен</span></span>
<span id="cb67-30"><a href="-6.html#cb67-30" aria-hidden="true"></a>    bot<span class="op">$</span><span class="kw">sendMessage</span>(<span class="dt">chat_id =</span> chat_id, </span>
<span id="cb67-31"><a href="-6.html#cb67-31" aria-hidden="true"></a>                    <span class="dt">text =</span> <span class="kw">str_glue</span>(<span class="st">&#39;*Перезапускаю бота* в {Sys.time()}&#39;</span>),</span>
<span id="cb67-32"><a href="-6.html#cb67-32" aria-hidden="true"></a>                    <span class="dt">parse_mode =</span> <span class="st">&#39;Markdown&#39;</span>)</span>
<span id="cb67-33"><a href="-6.html#cb67-33" aria-hidden="true"></a></span>
<span id="cb67-34"><a href="-6.html#cb67-34" aria-hidden="true"></a>    </span>
<span id="cb67-35"><a href="-6.html#cb67-35" aria-hidden="true"></a>  }, </span>
<span id="cb67-36"><a href="-6.html#cb67-36" aria-hidden="true"></a>  <span class="co"># действия которые будут выполненны в любом случае</span></span>
<span id="cb67-37"><a href="-6.html#cb67-37" aria-hidden="true"></a>  <span class="dt">finally =</span> {</span>
<span id="cb67-38"><a href="-6.html#cb67-38" aria-hidden="true"></a>    </span>
<span id="cb67-39"><a href="-6.html#cb67-39" aria-hidden="true"></a>    <span class="co"># останавливаем пулинг</span></span>
<span id="cb67-40"><a href="-6.html#cb67-40" aria-hidden="true"></a>    updater<span class="op">$</span><span class="kw">stop_polling</span>()</span>
<span id="cb67-41"><a href="-6.html#cb67-41" aria-hidden="true"></a>        </span>
<span id="cb67-42"><a href="-6.html#cb67-42" aria-hidden="true"></a>    <span class="co"># перезапускаем скрипт бота</span></span>
<span id="cb67-43"><a href="-6.html#cb67-43" aria-hidden="true"></a>    <span class="kw">source</span>(<span class="st">&#39;C:</span><span class="ch">\\</span><span class="st">telegram_bot</span><span class="ch">\\</span><span class="st">my_bot.R&#39;</span>) </span>
<span id="cb67-44"><a href="-6.html#cb67-44" aria-hidden="true"></a></span>
<span id="cb67-45"><a href="-6.html#cb67-45" aria-hidden="true"></a>  }</span>
<span id="cb67-46"><a href="-6.html#cb67-46" aria-hidden="true"></a>)</span></code></pre></div>
<p>В приведённом выше коде вам необходимо подставить токен созданного вами бота, и указать ID чата, в который бот будет отправлять уведомление о падении пуллинга.</p>
<p>В блок <code>expr</code> мы завернули процесс пуллинга, таким образом он постоянно контролируется конструкцией <code>tryCatch</code>.</p>
<p>Далее в блок <code>error</code> мы передали безымянную функцию, которая принимает всего один аргумент <code>err</code>, т.е. саму ошибку. Сообщение об ошибке мы получаем через <code>err$message</code>, и отправляем в указанный чат. С помощью <code>updater$bot$clean_updates()</code> мы очищаем очередь апдейтов бота, т.к. последний апдейт вызвал ошибку и падение нашего бота.</p>
<p>В блоке finally мы останавливаем пуллинг, и командой <code>source('C:\\telegram_bot\\my_bot.R')</code> занова запускаем скрипт с ботом.</p>
<p>Такая схема позволяет боту очищаться и подниматься при любой ошибке пуллинга.</p>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="-5.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="-tasks.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/rstudio/bookdown-demo/edit/master/06-trycatch.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["bookdown-demo.pdf", "bookdown-demo.epub"],
"toc": {
"collapse": "subsection"
}
});
});
</script>

</body>

</html>
